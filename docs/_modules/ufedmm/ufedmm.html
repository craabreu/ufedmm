<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ufedmm.ufedmm &#8212; UFED for OpenMM  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=572d9513" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=ccdb6887"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ufedmm.ufedmm</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: ufedmm</span>
<span class="sd">   :platform: Unix, Windows</span>
<span class="sd">   :synopsis: Unified Free Energy Dynamics with OpenMM</span>

<span class="sd">.. moduleauthor:: Charlles Abreu &lt;abreu@eq.ufrj.br&gt;</span>

<span class="sd">.. _Context:</span>
<span class="sd">    http://docs.openmm.org/latest/api-python/generated/openmm.openmm.Context.html</span>
<span class="sd">.. _CustomCVForce:</span>
<span class="sd">    http://docs.openmm.org/latest/api-python/generated/openmm.openmm.CustomCVForce.html</span>
<span class="sd">.. _CustomIntegrator:</span>
<span class="sd">    http://docs.openmm.org/latest/api-python/generated/openmm.openmm.CustomIntegrator.html</span>
<span class="sd">.. _Force:</span>
<span class="sd">    http://docs.openmm.org/latest/api-python/generated/openmm.openmm.Force.html</span>
<span class="sd">.. _Integrator:</span>
<span class="sd">    http://docs.openmm.org/latest/api-python/generated/openmm.openmm.Integrator.html</span>
<span class="sd">.. _Platform:</span>
<span class="sd">    http://docs.openmm.org/latest/api-python/generated/openmm.openmm.Platform.html</span>
<span class="sd">.. _System:</span>
<span class="sd">    http://docs.openmm.org/latest/api-python/generated/openmm.openmm.System.html</span>
<span class="sd">.. _State:</span>
<span class="sd">    http://docs.openmm.org/latest/api-python/generated/openmm.openmm.State.html</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">openmm</span>
<span class="kn">from</span> <span class="nn">openmm</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">unit</span>

<span class="kn">import</span> <span class="nn">ufedmm</span>


<span class="k">def</span> <span class="nf">_standardized</span><span class="p">(</span><span class="n">quantity</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the numerical value of a quantity in a unit of measurement compatible</span>
<span class="sd">    with the Molecular Dynamics unit system (mass in Da, distance in nm, time in ps,</span>
<span class="sd">    temperature in K, energy in kJ/mol, angle in rad).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">unit</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">quantity</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">quantity</span><span class="o">.</span><span class="n">value_in_unit_system</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">md_unit_system</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">quantity</span>


<span class="k">def</span> <span class="nf">_update_RMSD_forces</span><span class="p">(</span><span class="n">system</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update_RMSDForce</span><span class="p">(</span><span class="n">force</span><span class="p">):</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">force</span><span class="o">.</span><span class="n">getReferencePositions</span><span class="p">()</span><span class="o">.</span><span class="n">_value</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">N</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[:</span><span class="n">N</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">+=</span> <span class="p">[</span><span class="n">openmm</span><span class="o">.</span><span class="n">Vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">))</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setReferencePositions</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_RMSD_forces_in_cvforce</span><span class="p">(</span><span class="n">cvforce</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cvforce</span><span class="o">.</span><span class="n">getNumCollectiveVariables</span><span class="p">()):</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">cvforce</span><span class="o">.</span><span class="n">getCollectiveVariable</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">openmm</span><span class="o">.</span><span class="n">RMSDForce</span><span class="p">):</span>
                <span class="n">_update_RMSDForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">openmm</span><span class="o">.</span><span class="n">CustomCVForce</span><span class="p">):</span>
                <span class="n">_update_RMSD_forces_in_cvforce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">force</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">getForces</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">openmm</span><span class="o">.</span><span class="n">RMSDForce</span><span class="p">):</span>
            <span class="n">_update_RMSDForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">openmm</span><span class="o">.</span><span class="n">CustomCVForce</span><span class="p">):</span>
            <span class="n">_update_RMSD_forces_in_cvforce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>


<div class="viewcode-block" id="CollectiveVariable">
<a class="viewcode-back" href="../../pythonapi/ufedmm.html#ufedmm.ufedmm.CollectiveVariable">[docs]</a>
<span class="k">class</span> <span class="nc">CollectiveVariable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A function of the particle coordinates, evaluated by means of an OpenMM Force_</span>
<span class="sd">    object.</span>

<span class="sd">    Quoting OpenMM&#39;s CustomCVForce_ manual entry:</span>

<span class="sd">        &quot;Each collective variable is defined by a Force object. The Force&#39;s potential</span>
<span class="sd">        energy is computed, and that becomes the value of the variable. This provides</span>
<span class="sd">        enormous flexibility in defining collective variables, especially by using</span>
<span class="sd">        custom forces. Anything that can be computed as a potential function can also</span>
<span class="sd">        be used as a collective variable.&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        id : str</span>
<span class="sd">            A valid identifier string for this collective variable.</span>
<span class="sd">        force : openmm.Force</span>
<span class="sd">            An OpenMM Force_ object whose energy function is used to evaluate this</span>
<span class="sd">            collective variable.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">        &gt;&gt;&gt; import openmm</span>
<span class="sd">        &gt;&gt;&gt; import ufedmm</span>
<span class="sd">        &gt;&gt;&gt; from openmm import unit</span>
<span class="sd">        &gt;&gt;&gt; cv = ufedmm.CollectiveVariable(&#39;psi&#39;, openmm.CustomTorsionForce(&#39;theta&#39;))</span>
<span class="sd">        &gt;&gt;&gt; cv.force.addTorsion(0, 1, 2, 3, [])</span>
<span class="sd">        0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">force</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">id</span><span class="o">.</span><span class="n">isidentifier</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parameter id must be a valid variable identifier&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">force</span>

    <span class="k">def</span> <span class="nf">_create_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
        <span class="n">system_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">force</span> <span class="ow">in</span> <span class="n">system_copy</span><span class="o">.</span><span class="n">getForces</span><span class="p">():</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">force_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">)</span>
        <span class="n">force_copy</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">system_copy</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force_copy</span><span class="p">)</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="n">openmm</span><span class="o">.</span><span class="n">Platform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="s2">&quot;Reference&quot;</span><span class="p">)</span>
        <span class="n">_update_RMSD_forces</span><span class="p">(</span><span class="n">system_copy</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">openmm</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">system_copy</span><span class="p">,</span> <span class="n">openmm</span><span class="o">.</span><span class="n">CustomIntegrator</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">platform</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span>

<div class="viewcode-block" id="CollectiveVariable.evaluate">
<a class="viewcode-back" href="../../pythonapi/ufedmm.html#ufedmm.ufedmm.CollectiveVariable.evaluate">[docs]</a>
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">cv_unit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes the value of the collective variable for a given system and a given</span>
<span class="sd">        set of particle coordinates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            system : openmm.System</span>
<span class="sd">                The system for which the collective variable will be evaluated.</span>
<span class="sd">            positions : list of openmm.Vec3</span>
<span class="sd">                A list whose size equals the number of particles in the system and which</span>
<span class="sd">                contains the coordinates of these particles.</span>

<span class="sd">        Keyword Args</span>
<span class="sd">        ------------</span>
<span class="sd">            cv_unit : unit.Unit, default=None</span>
<span class="sd">                The unity of measurement of the collective variable. If this is `None`,</span>
<span class="sd">                then a numerical value is returned based on the OpenMM default units.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            float or unit.Quantity</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">            &gt;&gt;&gt; import ufedmm</span>
<span class="sd">            &gt;&gt;&gt; from openmm import unit</span>
<span class="sd">            &gt;&gt;&gt; model = ufedmm.AlanineDipeptideModel()</span>
<span class="sd">            &gt;&gt;&gt; model.phi.evaluate(model.system, model.positions)</span>
<span class="sd">            3.141592653589793</span>
<span class="sd">            &gt;&gt;&gt; model.psi.evaluate(model.system, model.positions)</span>
<span class="sd">            3.141592653589793</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_context</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">positions</span><span class="p">)</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">})</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">energy</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">kilojoules_per_mole</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cv_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">*=</span> <span class="n">cv_unit</span> <span class="o">/</span> <span class="n">_standardized</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">cv_unit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="CollectiveVariable.effective_mass">
<a class="viewcode-back" href="../../pythonapi/ufedmm.html#ufedmm.ufedmm.CollectiveVariable.effective_mass">[docs]</a>
    <span class="k">def</span> <span class="nf">effective_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">cv_unit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes the effective mass of the collective variable for a given system and</span>
<span class="sd">        a given set of particle coordinates.</span>

<span class="sd">        The effective mass of a collective variable :math:`q(\\mathbf{r})` is defined as</span>
<span class="sd">        :cite:`Cuendet_2014`:</span>

<span class="sd">        .. math::</span>
<span class="sd">            m_\\mathrm{eff} = \\left(</span>
<span class="sd">                \\sum_{j=1}^N \\frac{1}{m_j} \\left\\|</span>
<span class="sd">                    \\frac{dq}{d\\mathbf{r}_j}</span>
<span class="sd">                \\right\\|^2</span>
<span class="sd">            \\right)^{-1}</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            system : openmm.System</span>
<span class="sd">                The system for which the collective variable will be evaluated.</span>
<span class="sd">            positions : list of openmm.Vec3</span>
<span class="sd">                A list whose size equals the number of particles in the system and which</span>
<span class="sd">                contains the coordinates of these particles.</span>

<span class="sd">        Keyword Args</span>
<span class="sd">        ------------</span>
<span class="sd">            cv_unit : unit.Unit, default=None</span>
<span class="sd">                The unity of measurement of the collective variable. If this is `None`,</span>
<span class="sd">                then a numerical value is returned based on the OpenMM default units.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            float or unit.Quantity</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">            &gt;&gt;&gt; import ufedmm</span>
<span class="sd">            &gt;&gt;&gt; from openmm import unit</span>
<span class="sd">            &gt;&gt;&gt; model = ufedmm.AlanineDipeptideModel()</span>
<span class="sd">            &gt;&gt;&gt; model.phi.effective_mass(model.system, model.positions)</span>
<span class="sd">            0.04795887...</span>
<span class="sd">            &gt;&gt;&gt; model.psi.effective_mass(model.system, model.positions)</span>
<span class="sd">            0.05115582...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_context</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">positions</span><span class="p">)</span>
        <span class="n">forces</span> <span class="o">=</span> <span class="n">_standardized</span><span class="p">(</span>
            <span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getForces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">})</span><span class="o">.</span><span class="n">getForces</span><span class="p">(</span><span class="n">asNumpy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">f</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">/</span> <span class="n">_standardized</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">getParticleMass</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">forces</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">effective_mass</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">denom</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cv_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">_standardized</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">cv_unit</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">effective_mass</span> <span class="o">*=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">dalton</span> <span class="o">*</span> <span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">nanometers</span> <span class="o">/</span> <span class="n">cv_unit</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">effective_mass</span></div>
</div>



<div class="viewcode-block" id="DynamicalVariable">
<a class="viewcode-back" href="../../pythonapi/ufedmm.html#ufedmm.ufedmm.DynamicalVariable">[docs]</a>
<span class="k">class</span> <span class="nc">DynamicalVariable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An extended phase-space variable, whose dynamics is coupled to that of one of</span>
<span class="sd">    more collective variables of a system.</span>

<span class="sd">    The coupling occurs in the form of a potential energy term involving this dynamical</span>
<span class="sd">    variable and its associated collective variables.</span>

<span class="sd">    The default potential is a harmonic driving of the type:</span>

<span class="sd">    .. math::</span>
<span class="sd">        V(s, \\mathbf r) = \\frac{\\kappa}{2} [s - q(\\mathbf r)]^2</span>

<span class="sd">    where :math:`s` is the new dynamical variable, :math:`q(\\mathbf r)` is its</span>
<span class="sd">    associated collective variable, and :math:`kappa` is a force constant.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        id : str</span>
<span class="sd">            A valid identifier string for this dynamical variable.</span>
<span class="sd">        min_value : float or unit.Quantity</span>
<span class="sd">            The minimum allowable value for this dynamical variable.</span>
<span class="sd">        max_value : float or unit.Quantity</span>
<span class="sd">            The maximum allowable value for this dynamical variable.</span>
<span class="sd">        mass : float or unit.Quantity</span>
<span class="sd">            The mass assigned to this dynamical variable, whose unit of measurement must</span>
<span class="sd">            be compatible with `unit.dalton*(unit.nanometers/X)**2`, where `X` is the</span>
<span class="sd">            unit of measurement of the dynamical variable itself.</span>
<span class="sd">        temperature : float or unit.Quantity</span>
<span class="sd">            The temperature of the heat bath attached to this variable.</span>
<span class="sd">        colvars : :class:`~ufedmm.ufedmm.CollectiveVariable` or list thereof</span>
<span class="sd">            Either a single colective variable or a list.</span>
<span class="sd">        potential : float or unit.Quantity or str</span>
<span class="sd">            Either the value of the force constant of a harmonic driving potential or an</span>
<span class="sd">            algebraic expression giving the energy of the system as a function of this</span>
<span class="sd">            dynamical variable and its associated collective variable. Such expression</span>
<span class="sd">            can also contain a set of global parameters, whose values must be passed as</span>
<span class="sd">            keyword arguments (see below).</span>

<span class="sd">    Keyword Args</span>
<span class="sd">    ------------</span>
<span class="sd">        periodic : bool, default=True</span>
<span class="sd">            Whether the collective variable is periodic with period</span>
<span class="sd">            `L=max_value-min_value`.</span>
<span class="sd">        sigma : float or unit.Quantity, default=None</span>
<span class="sd">            The standard deviation. If this is `None`, then no bias will be considered.</span>
<span class="sd">        grid_size : int, default=None</span>
<span class="sd">            The grid size. If this is `None` and `sigma` is finite, then a convenient</span>
<span class="sd">            value will be automatically chosen.</span>
<span class="sd">        **parameters</span>
<span class="sd">            Names and values of global parameters present in the algebraic expression</span>
<span class="sd">            defined as `potential` (see above).</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">        &gt;&gt;&gt; import openmm</span>
<span class="sd">        &gt;&gt;&gt; import ufedmm</span>
<span class="sd">        &gt;&gt;&gt; from openmm import unit</span>
<span class="sd">        &gt;&gt;&gt; cv = ufedmm.CollectiveVariable(&#39;psi&#39;, openmm.CustomTorsionForce(&#39;theta&#39;))</span>
<span class="sd">        &gt;&gt;&gt; cv.force.addTorsion(0, 1, 2, 3, [])</span>
<span class="sd">        0</span>
<span class="sd">        &gt;&gt;&gt; mass = 50*unit.dalton*(unit.nanometer/unit.radians)**2</span>
<span class="sd">        &gt;&gt;&gt; K = 1000*unit.kilojoules_per_mole/unit.radians**2</span>
<span class="sd">        &gt;&gt;&gt; Ts = 1500*unit.kelvin</span>
<span class="sd">        &gt;&gt;&gt; ufedmm.DynamicalVariable(</span>
<span class="sd">        ...     &#39;s_psi&#39;, -180*unit.degrees, 180*unit.degrees, mass, Ts, cv, K</span>
<span class="sd">        ... )</span>
<span class="sd">        &lt;s_psi in [-3.141592653589793, 3.141592653589793], periodic, m=50, T=1500&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">,</span>
        <span class="n">min_value</span><span class="p">,</span>
        <span class="n">max_value</span><span class="p">,</span>
        <span class="n">mass</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">,</span>
        <span class="n">colvars</span><span class="p">,</span>
        <span class="n">potential</span><span class="p">,</span>
        <span class="n">periodic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">grid_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">parameters</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span> <span class="o">=</span> <span class="n">_standardized</span><span class="p">(</span><span class="n">min_value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_value</span> <span class="o">=</span> <span class="n">_standardized</span><span class="p">(</span><span class="n">max_value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">_standardized</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">_standardized</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">colvars</span> <span class="o">=</span> <span class="n">colvars</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colvars</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="k">else</span> <span class="p">[</span><span class="n">colvars</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">potential</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">potential</span> <span class="o">=</span> <span class="n">potential</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">_standardized</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cv_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colvars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
            <span class="k">if</span> <span class="n">periodic</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">potential</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;0.5*K_</span><span class="si">{</span><span class="n">cv_id</span><span class="si">}</span><span class="s2">*min(d</span><span class="si">{</span><span class="n">cv_id</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_range</span><span class="si">}</span><span class="s2">-d</span><span class="si">{</span><span class="n">cv_id</span><span class="si">}</span><span class="s2">)^2&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">potential</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;; d</span><span class="si">{</span><span class="n">cv_id</span><span class="si">}</span><span class="s2">=abs(</span><span class="si">{</span><span class="n">cv_id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">potential</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;0.5*K_</span><span class="si">{</span><span class="n">cv_id</span><span class="si">}</span><span class="s2">*(</span><span class="si">{</span><span class="n">cv_id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)^2&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;K_</span><span class="si">{</span><span class="n">cv_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">_standardized</span><span class="p">(</span><span class="n">potential</span><span class="p">)}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="o">=</span> <span class="n">periodic</span>

        <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sigma</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">_standardized</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scaled_variance</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_range</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">grid_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_range</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">=</span> <span class="n">grid_size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">openmm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_energy_function</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s2">&quot;Lx&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;m=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="si">}</span><span class="s2">, T=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;periodic&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="k">else</span> <span class="s2">&quot;non-periodic&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> in &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_value</span><span class="si">}</span><span class="s2">], </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">properties</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">min_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="p">,</span>
            <span class="n">max_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_value</span><span class="p">,</span>
            <span class="n">mass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
            <span class="n">colvars</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colvars</span><span class="p">,</span>
            <span class="n">potential</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">potential</span><span class="p">,</span>
            <span class="n">periodic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">,</span>
            <span class="n">sigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span>
            <span class="n">grid_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_particle_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lx</span><span class="p">):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">Lx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="k">else</span> <span class="n">Lx</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_range</span> <span class="o">/</span> <span class="n">length</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">_particle_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">Lx</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">Lx</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="k">else</span> <span class="n">Lx</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">openmm</span><span class="o">.</span><span class="n">Vec3</span><span class="p">(</span><span class="n">length</span> <span class="o">*</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_range</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">nanometer</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_energy_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the algebraic expression that transforms the x coordinate of a</span>
<span class="sd">        particle into this dynamical variables.</span>

<span class="sd">        Keyword Args</span>
<span class="sd">        ------------</span>
<span class="sd">            index : str or int, default=&#39;&#39;</span>
<span class="sd">                An index for the particle in question, if needed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="si">}</span><span class="s2">+</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_range</span><span class="si">}</span><span class="s2">*(x</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">/Lx-floor(x</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">/Lx))&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min_value</span><span class="si">}</span><span class="s2">+</span><span class="si">{</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_range</span><span class="si">}</span><span class="s2">*min(pos</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">,1-pos</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">energy</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;;pos</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">=x</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">/Lx-floor(x</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">/Lx)&quot;</span>
        <span class="k">return</span> <span class="n">energy</span>

<div class="viewcode-block" id="DynamicalVariable.evaluate">
<a class="viewcode-back" href="../../pythonapi/ufedmm.html#ufedmm.ufedmm.DynamicalVariable.evaluate">[docs]</a>
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">Lx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes the value of this dynamical variable for a given x coordinate and a</span>
<span class="sd">        given length of the simulation box in the x direction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            x : float or unit.Quantity</span>
<span class="sd">                The x coordinate.</span>
<span class="sd">            Lx : float or unit.Quantity</span>
<span class="sd">                The length of the simulation box in the x direction.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">Lx</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">Lx</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_range</span> <span class="o">*</span> <span class="n">pos</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_value</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_range</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pos</span><span class="p">)</span></div>
</div>



<span class="k">def</span> <span class="nf">_get_energy_function</span><span class="p">(</span><span class="n">variables</span><span class="p">):</span>
    <span class="n">energies</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">potential</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">]</span>
    <span class="n">energy_terms</span> <span class="o">=</span> <span class="p">[</span><span class="n">energy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">energy</span> <span class="ow">in</span> <span class="n">energies</span><span class="p">]</span>
    <span class="n">definitions</span> <span class="o">=</span> <span class="p">[</span><span class="n">energy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">energy</span> <span class="ow">in</span> <span class="n">energies</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">expression</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">energy_terms</span><span class="p">)]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">definitions</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">expression</span>


<span class="k">def</span> <span class="nf">_get_parameters</span><span class="p">(</span><span class="n">variables</span><span class="p">):</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parameters</span>


<span class="k">class</span> <span class="nc">PeriodicTask</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation</span><span class="p">,</span> <span class="n">force_group</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">describeNextReport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation</span><span class="p">):</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">-</span> <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getStepCount</span><span class="p">()</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">saveCheckpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">loadCheckpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">_Metadynamics</span><span class="p">(</span><span class="n">PeriodicTask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extended-space Metadynamics.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        variables : list of :class:`DynamicalVariable`</span>
<span class="sd">            A list of extended-space dynamical variables to which the metadynamics bias</span>
<span class="sd">            must be applied. In fact, dynamical variables with `sigma = None` will not</span>
<span class="sd">            be considered.</span>
<span class="sd">        height : float or unit.Quantity</span>
<span class="sd">            The height of the Gaussian potential hills to be deposited. If the</span>
<span class="sd">            `bias_factor` keyword is defined (see below), then this is the unscaled</span>
<span class="sd">            height.</span>
<span class="sd">        frequency : int</span>
<span class="sd">            The frequency of Gaussian hill deposition.</span>

<span class="sd">    Keyword Args</span>
<span class="sd">    ------------</span>
<span class="sd">        bias_factor : float, default=None</span>
<span class="sd">            Scales the height of the hills added to the bias potential. If it is `None`,</span>
<span class="sd">            then the hills will have a constant height over time. For a bias factor to</span>
<span class="sd">            be applicable, all bias variables must be at the same temperature T. The</span>
<span class="sd">            extended-space dynamical variables are sampled as if the effective</span>
<span class="sd">            temperature were T*bias_factor.</span>
<span class="sd">        buffer_size : int, default=100</span>
<span class="sd">            The buffer size.</span>
<span class="sd">        grid_expansion : int, default=20</span>
<span class="sd">            The number of extra grid points to be used in periodic directions of</span>
<span class="sd">            multidimensional tabulated functions. This aims at avoiding boundary</span>
<span class="sd">            discontinuity artifacts.</span>
<span class="sd">        enforce_gridless : bool, default=False</span>
<span class="sd">            Enforce gridless metadynamics even for 1D to 3D problems.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">variables</span><span class="p">,</span>
        <span class="n">height</span><span class="p">,</span>
        <span class="n">frequency</span><span class="p">,</span>
        <span class="n">bias_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">buffer_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">grid_expansion</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">enforce_gridless</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">variables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_indices</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">_standardized</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_factor</span> <span class="o">=</span> <span class="n">bias_factor</span>
        <span class="k">if</span> <span class="n">bias_factor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_variables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">temperature</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">temperature</span> <span class="o">!=</span> <span class="n">temperature</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_variables</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Well-tempered metadynamics requires same temperature &quot;</span>
                    <span class="s2">&quot;for all variables.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delta_kT</span> <span class="o">=</span> <span class="n">_standardized</span><span class="p">(</span>
                <span class="p">(</span><span class="n">bias_factor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">MOLAR_GAS_CONSTANT_R</span> <span class="o">*</span> <span class="n">temperature</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">buffer_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_expansion</span> <span class="o">=</span> <span class="n">grid_expansion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_grid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_variables</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">enforce_gridless</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interpolation_grid_force</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_grid</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hills_force</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_interpolation_grid_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_widths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bounds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">full_periodic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_full_periodic</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">v</span><span class="o">.</span><span class="n">periodic</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_variables</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_variables</span><span class="p">:</span>
            <span class="n">extra_points</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_expansion</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">periodic</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">full_periodic</span>
                <span class="k">else</span> <span class="mi">0</span>
            <span class="p">)</span>
            <span class="n">extra_range</span> <span class="o">=</span> <span class="n">extra_points</span> <span class="o">*</span> <span class="n">v</span><span class="o">.</span><span class="n">_range</span> <span class="o">/</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_widths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">extra_points</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bounds</span> <span class="o">+=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">min_value</span> <span class="o">-</span> <span class="n">extra_range</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">max_value</span> <span class="o">+</span> <span class="n">extra_range</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extra_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extra_points</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_widths</span><span class="p">))</span>
        <span class="n">num_bias_variables</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_variables</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_bias_variables</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="n">openmm</span><span class="o">.</span><span class="n">Continuous1DFunction</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bias</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_bounds</span><span class="p">,</span> <span class="n">full_periodic</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">num_bias_variables</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="n">openmm</span><span class="o">.</span><span class="n">Continuous2DFunction</span><span class="p">(</span>
                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_widths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bias</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_bounds</span><span class="p">,</span> <span class="n">full_periodic</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="n">openmm</span><span class="o">.</span><span class="n">Continuous3DFunction</span><span class="p">(</span>
                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_widths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bias</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_bounds</span><span class="p">,</span> <span class="n">full_periodic</span>
            <span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;metad_bias_scale*bias(</span><span class="si">{</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">bias_variables</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_variables</span><span class="p">):</span>
            <span class="n">expression</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;;</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">_get_energy_function</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">openmm</span><span class="o">.</span><span class="n">CustomCVForce</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_bias_variables</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">openmm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
            <span class="n">x</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addCollectiveVariable</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="s2">&quot;bias&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s2">&quot;Lx&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s2">&quot;metad_bias_scale&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">addEnergyParameterDerivative</span><span class="p">(</span><span class="s2">&quot;metad_bias_scale&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">force</span>

    <span class="k">def</span> <span class="nf">_hills_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">num_bias_variables</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_variables</span><span class="p">)</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;center</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_bias_variables</span><span class="p">)]</span>
        <span class="n">exponents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">center</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_variables</span><span class="p">,</span> <span class="n">centers</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>  <span class="c1"># von Mises</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">v</span><span class="o">.</span><span class="n">_range</span>
                <span class="n">exponents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">factor</span><span class="o">*</span><span class="n">v</span><span class="o">.</span><span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="si">}</span><span class="s2">*(cos(</span><span class="si">{</span><span class="n">factor</span><span class="si">}</span><span class="s2">*(</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">))-1)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Gauss</span>
                <span class="n">exponents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="o">-</span><span class="mf">0.5</span><span class="o">/</span><span class="n">v</span><span class="o">.</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="si">}</span><span class="s2">)*(</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">)^2&quot;</span><span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;height*exp(</span><span class="si">{</span><span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exponents</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_variables</span><span class="p">):</span>
            <span class="n">expression</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;;</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">_get_energy_function</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">openmm</span><span class="o">.</span><span class="n">CustomCompoundBondForce</span><span class="p">(</span><span class="n">num_bias_variables</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">addPerBondParameter</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">center</span> <span class="ow">in</span> <span class="n">centers</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addPerBondParameter</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s2">&quot;Lx&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">force</span>

    <span class="k">def</span> <span class="nf">_add_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_hills</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">getNumBonds</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_variables</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">reinitialize</span><span class="p">(</span><span class="n">preserveState</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation</span><span class="p">,</span> <span class="n">bias</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_grid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bias</span> <span class="o">+=</span> <span class="n">bias</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_variables</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">setFunctionParameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bias</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_bounds</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">setFunctionParameters</span><span class="p">(</span>
                    <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_widths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bias</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_bounds</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">updateParametersInContext</span><span class="p">(</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">context</span>
        <span class="n">np</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">getSystem</span><span class="p">()</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particles</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span> <span class="o">+</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_indices</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Lx</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">getParameter</span><span class="p">(</span><span class="s2">&quot;Lx&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_grid</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">particle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">getCollectiveVariable</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">setParticleParameters</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="n">particle</span><span class="p">,</span> <span class="p">[]</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_hills</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_total_hills</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">reinitialize</span><span class="p">(</span><span class="n">preserveState</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_grid</span><span class="p">:</span>
            <span class="n">steps_until_next_report</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">-</span> <span class="n">simulation</span><span class="o">.</span><span class="n">currentStep</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">steps_until_next_report</span> <span class="o">&gt;</span> <span class="n">steps</span><span class="p">:</span>
                <span class="n">required_hills</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">required_hills</span> <span class="o">=</span> <span class="p">(</span><span class="n">steps</span> <span class="o">-</span> <span class="n">steps_until_next_report</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_total_hills</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_hills</span> <span class="o">+</span> <span class="n">required_hills</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_buffer</span><span class="p">(</span><span class="n">simulation</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getDynamicalVariables</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_height</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hills_state</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getParameterDerivatives</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">hills_state</span><span class="o">.</span><span class="n">getEnergyParameterDerivatives</span><span class="p">()[</span><span class="s2">&quot;metad_bias_scale&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_height</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">energy</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_kT</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_grid</span><span class="p">:</span>
            <span class="n">hills</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_variables</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">centers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="o">.</span><span class="n">min_value</span><span class="p">)</span> <span class="o">/</span> <span class="n">v</span><span class="o">.</span><span class="n">_range</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span> <span class="o">-</span> <span class="n">x</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>  <span class="c1"># von Mises</span>
                    <span class="n">exponents</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">dist</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                        <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">v</span><span class="o">.</span><span class="n">_scaled_variance</span>
                    <span class="p">)</span>
                    <span class="n">exponents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">exponents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">exponents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">exponents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># Gauss</span>
                    <span class="n">exponents</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">dist</span> <span class="o">*</span> <span class="n">dist</span> <span class="o">/</span> <span class="n">v</span><span class="o">.</span><span class="n">_scaled_variance</span>
                <span class="n">hills</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">exponents</span><span class="p">))</span>
            <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_variables</span><span class="p">)</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">hills</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="k">else</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="o">.</span><span class="n">outer</span><span class="p">,</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">hills</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_full_periodic</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_variables</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_points</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">begin</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                            <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">axis</span> <span class="k">else</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                            <span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">axis</span> <span class="k">else</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">bias</span><span class="p">[</span><span class="n">end</span><span class="p">],</span> <span class="n">bias</span><span class="p">,</span> <span class="n">bias</span><span class="p">[</span><span class="n">begin</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_bias</span><span class="p">(</span><span class="n">simulation</span><span class="p">,</span> <span class="n">bias</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_hills</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">getNumBonds</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_buffer</span><span class="p">(</span><span class="n">simulation</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">setBondParameters</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_num_hills</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">]</span> <span class="o">+</span> <span class="n">centers</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_hills</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">updateParametersInContext</span><span class="p">(</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">saveCheckpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_grid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bias</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_hills</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">parameter_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_hills</span><span class="p">):</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">getBondParameters</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="n">parameter_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">parameter_list</span><span class="p">)</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">])</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">loadCheckpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_grid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bias</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_variables</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">setFunctionParameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bias</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_bounds</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">setFunctionParameters</span><span class="p">(</span>
                    <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_widths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bias</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_bounds</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">updateParametersInContext</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">npars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_variables</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">nhills</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_hills</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">parameter_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">nhills</span> <span class="o">*</span> <span class="n">npars</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="p">(</span><span class="n">nhills</span><span class="p">,</span> <span class="n">npars</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nhills</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">getNumBonds</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">npars</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_total_hills</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">getNumBonds</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">parameters</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parameter_array</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">setBondParameters</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_total_hills</span> <span class="o">-</span> <span class="n">nhills</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">setBondParameters</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">npars</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">reinitialize</span><span class="p">(</span><span class="n">preserveState</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


<div class="viewcode-block" id="ExtendedSpaceState">
<a class="viewcode-back" href="../../pythonapi/ufedmm.html#ufedmm.ufedmm.ExtendedSpaceState">[docs]</a>
<span class="k">class</span> <span class="nc">ExtendedSpaceState</span><span class="p">(</span><span class="n">openmm</span><span class="o">.</span><span class="n">State</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An extension of OpenMM&#39;s State_ class.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span>
            <span class="n">state</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="vm">__class__</span><span class="p">),</span> <span class="p">{}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_variables</span> <span class="o">=</span> <span class="n">variables</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPeriodicBoxVectors</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Lx</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">x</span>

    <span class="k">def</span> <span class="nf">_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">asNumpy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="n">vector</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">asNumpy</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">vector</span><span class="p">))</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">)</span>
        <span class="n">particles_contribution</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[:</span><span class="n">num</span><span class="p">,</span> <span class="p">:]</span> <span class="k">if</span> <span class="n">asNumpy</span> <span class="k">else</span> <span class="n">vector</span><span class="p">[:</span><span class="n">num</span><span class="p">]</span>
        <span class="n">variables_contribution</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">vector</span><span class="p">[</span><span class="n">num</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">asNumpy</span> <span class="k">else</span> <span class="p">[</span><span class="n">vec</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">vec</span> <span class="ow">in</span> <span class="n">vector</span><span class="p">[</span><span class="n">num</span><span class="p">:]]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">particles_contribution</span><span class="p">,</span> <span class="n">variables_contribution</span>

<div class="viewcode-block" id="ExtendedSpaceState.getPositions">
<a class="viewcode-back" href="../../pythonapi/ufedmm.html#ufedmm.ufedmm.ExtendedSpaceState.getPositions">[docs]</a>
    <span class="k">def</span> <span class="nf">getPositions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asNumpy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extended</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the positions of all physical particles and optionally also gets the</span>
<span class="sd">        positions of the extra particles from which the extended-space dynamical</span>
<span class="sd">        variables are computed.</span>

<span class="sd">        Keyword Args</span>
<span class="sd">        ------------</span>
<span class="sd">            asNumpy : bool, default=False</span>
<span class="sd">                Whether to return Numpy arrays instead of lists of openmm.Vec3.</span>
<span class="sd">            extended : bool, default=False</span>
<span class="sd">                Whether to include the positions of the extra particles from which the</span>
<span class="sd">                extended-space dynamical variables are computed.</span>
<span class="sd">            split : bool, default=True</span>
<span class="sd">                Whether to return the positions of the physical particles and the</span>
<span class="sd">                positions of the extra particles separately.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            list(openmm.Vec3) or numpy.ndarray</span>
<span class="sd">                If `extended=False` or `split=False`.</span>
<span class="sd">            list(openmm.Vec3) or numpy.ndarray, list(float) or numpy.ndarray</span>
<span class="sd">                If `extended=True` and `split=True`.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">            Exception</span>
<span class="sd">                If positions were not requested in the ``context.getState()`` call.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_positions</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">getPositions</span><span class="p">(</span><span class="n">asNumpy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extended</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">split</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_positions</span>
        <span class="n">positions</span><span class="p">,</span> <span class="n">xvars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">(</span><span class="n">all_positions</span><span class="p">,</span> <span class="n">asNumpy</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">xvars</span><span class="p">)</span> <span class="k">if</span> <span class="n">extended</span> <span class="k">else</span> <span class="n">positions</span></div>


<div class="viewcode-block" id="ExtendedSpaceState.getVelocities">
<a class="viewcode-back" href="../../pythonapi/ufedmm.html#ufedmm.ufedmm.ExtendedSpaceState.getVelocities">[docs]</a>
    <span class="k">def</span> <span class="nf">getVelocities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asNumpy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extended</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the velocities of all physical particles and optionally also gets the</span>
<span class="sd">        velocities of the extra particles associated to the extended- space dynamical</span>
<span class="sd">        variables.</span>

<span class="sd">        Keyword Args</span>
<span class="sd">        ------------</span>
<span class="sd">            asNumpy : bool, default=False</span>
<span class="sd">                Whether to return Numpy arrays instead of lists of openmm.Vec3.</span>
<span class="sd">            extended : bool, default=False</span>
<span class="sd">                Whether to include the velocities of the extra particles.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            list(openmm.Vec3)</span>
<span class="sd">                If `asNumpy=False` and `extended=False`.</span>
<span class="sd">            numpy.ndarray</span>
<span class="sd">                If `asNumpy=True` and `extended=False`.</span>
<span class="sd">            list(openmm.Vec3), list(float)</span>
<span class="sd">                If `asNumpy=False` and `extended=True`.</span>
<span class="sd">            numpy.ndarray, numpy.ndarray</span>
<span class="sd">                If `asNumpy=True` and `extended=True`.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">            Exception</span>
<span class="sd">                If velocities were not requested in the ``context.getState()`` call.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">velocities</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">getVelocities</span><span class="p">(</span><span class="n">asNumpy</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">extended</span><span class="p">:</span>
            <span class="n">velocities</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">(</span><span class="n">velocities</span><span class="p">,</span> <span class="n">asNumpy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">velocities</span></div>


<div class="viewcode-block" id="ExtendedSpaceState.getDynamicalVariables">
<a class="viewcode-back" href="../../pythonapi/ufedmm.html#ufedmm.ufedmm.ExtendedSpaceState.getDynamicalVariables">[docs]</a>
    <span class="k">def</span> <span class="nf">getDynamicalVariables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the values of the extended-space dynamical variables.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            list(float)</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">            Exception</span>
<span class="sd">                If positions were not requested in the ``context.getState()`` call.</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">            &gt;&gt;&gt; import ufedmm</span>
<span class="sd">            &gt;&gt;&gt; import numpy as np</span>
<span class="sd">            &gt;&gt;&gt; model = ufedmm.AlanineDipeptideModel()</span>
<span class="sd">            &gt;&gt;&gt; integrator = ufedmm.CustomIntegrator(300, 0.001)</span>
<span class="sd">            &gt;&gt;&gt; args = [-np.pi, np.pi, 50, 1500, model.phi, 1000]</span>
<span class="sd">            &gt;&gt;&gt; s_phi = ufedmm.DynamicalVariable(&#39;s_phi&#39;, *args)</span>
<span class="sd">            &gt;&gt;&gt; s_psi = ufedmm.DynamicalVariable(&#39;s_psi&#39;, *args)</span>
<span class="sd">            &gt;&gt;&gt; context = ufedmm.ExtendedSpaceContext(</span>
<span class="sd">            ...     [s_phi, s_psi], model.system, integrator</span>
<span class="sd">            ... )</span>
<span class="sd">            &gt;&gt;&gt; context.setPositions(model.positions)</span>
<span class="sd">            &gt;&gt;&gt; context.getState(getPositions=True).getDynamicalVariables()</span>
<span class="sd">            [-3.141592653589793, -3.141592653589793]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">xvars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">getPositions</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Lx</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_variables</span><span class="p">,</span> <span class="n">xvars</span><span class="p">)]</span></div>
</div>



<div class="viewcode-block" id="ExtendedSpaceContext">
<a class="viewcode-back" href="../../pythonapi/ufedmm.html#ufedmm.ufedmm.ExtendedSpaceContext">[docs]</a>
<span class="k">class</span> <span class="nc">ExtendedSpaceContext</span><span class="p">(</span><span class="n">openmm</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An extension of OpenMM&#39;s Context_ class.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        variables : list(DynamicalVariable)</span>
<span class="sd">            The dynamical variables to be added to the system&#39;s phase space.</span>
<span class="sd">        system : openmm.System</span>
<span class="sd">            The System_ which will be simulated</span>
<span class="sd">        integrator : openmm.Integrator</span>
<span class="sd">            The Integrator_ which will be used to simulate the System_.</span>
<span class="sd">        platform : openmm.Platform</span>
<span class="sd">            The Platform_ to use for calculations.</span>
<span class="sd">        properties : dict(str: str)</span>
<span class="sd">            A set of values for platform-specific properties. Keys are the property</span>
<span class="sd">            names.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">        variables : list(DynamicalVariable)</span>
<span class="sd">            The dynamical variables added to the system&#39;s phase space.</span>
<span class="sd">        driving_forces : list[openmm.CustomCVForce]</span>
<span class="sd">            A list of CustomCVForce_ objects responsible for evaluating the potential</span>
<span class="sd">            energy terms which couples the extra dynamical variables to their associated</span>
<span class="sd">            collective variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">get_driving_force</span><span class="p">(</span><span class="n">variables</span><span class="p">):</span>
            <span class="n">driving_force</span> <span class="o">=</span> <span class="n">openmm</span><span class="o">.</span><span class="n">CustomCVForce</span><span class="p">(</span><span class="n">_get_energy_function</span><span class="p">(</span><span class="n">variables</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">_get_parameters</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">driving_force</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
                <span class="n">driving_force</span><span class="o">.</span><span class="n">addCollectiveVariable</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">force</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">colvar</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">colvars</span><span class="p">:</span>
                    <span class="n">driving_force</span><span class="o">.</span><span class="n">addCollectiveVariable</span><span class="p">(</span><span class="n">colvar</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">colvar</span><span class="o">.</span><span class="n">force</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">driving_force</span>

        <span class="n">driving_force_variables</span> <span class="o">=</span> <span class="p">[[]]</span>
        <span class="n">added_colvars</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="n">colvars_to_add</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">colvars</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">added_colvars</span> <span class="o">+</span> <span class="n">colvars_to_add</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">:</span>
                <span class="n">driving_force_variables</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">added_colvars</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">driving_force_variables</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
            <span class="n">added_colvars</span> <span class="o">+=</span> <span class="n">colvars_to_add</span>
        <span class="n">driving_forces</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_driving_force</span><span class="p">(</span><span class="nb">vars</span><span class="p">)</span> <span class="k">for</span> <span class="nb">vars</span> <span class="ow">in</span> <span class="n">driving_force_variables</span><span class="p">]</span>
        <span class="n">box_length_x</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">getDefaultPeriodicBoxVectors</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
        <span class="n">num_particles</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()</span>
        <span class="n">collective_variables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dfvars</span> <span class="ow">in</span> <span class="n">driving_force_variables</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">dfvars</span><span class="p">:</span>
                <span class="n">system</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">_particle_mass</span><span class="p">(</span><span class="n">box_length_x</span><span class="p">))</span>
                <span class="n">var</span><span class="o">.</span><span class="n">force</span><span class="o">.</span><span class="n">setParticleParameters</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_particles</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">num_particles</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">collective_variables</span> <span class="o">+=</span> <span class="n">var</span><span class="o">.</span><span class="n">colvars</span>
        <span class="k">for</span> <span class="n">force</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">getForces</span><span class="p">()</span> <span class="o">+</span> <span class="n">collective_variables</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_fake_particles</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">driving_force</span> <span class="ow">in</span> <span class="n">driving_forces</span><span class="p">:</span>
            <span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">driving_force</span><span class="p">)</span>
        <span class="n">_update_RMSD_forces</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setParameter</span><span class="p">(</span><span class="s2">&quot;Lx&quot;</span><span class="p">,</span> <span class="n">box_length_x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="n">variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driving_forces</span> <span class="o">=</span> <span class="n">driving_forces</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">driving_forces</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">driving_force</span> <span class="o">=</span> <span class="n">driving_forces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># for backwards compatibility</span>

    <span class="k">def</span> <span class="nf">_add_fake_particles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">openmm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">openmm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">force</span><span class="o">.</span><span class="n">getNumPerParticleParameters</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">openmm</span><span class="o">.</span><span class="n">CustomGBForce</span><span class="p">):</span>
            <span class="n">parameter_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span><span class="n">force</span><span class="o">.</span><span class="n">getParticleParameters</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">force</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()))</span>
            <span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s2">&quot;isreal&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">force</span><span class="o">.</span><span class="n">getNumEnergyTerms</span><span class="p">()):</span>
                <span class="n">expression</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">force</span><span class="o">.</span><span class="n">getEnergyTermParameters</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="n">energy</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;isreal*E_GB&quot;</span>
                    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">force</span><span class="o">.</span><span class="n">SingleParticle</span>
                    <span class="k">else</span> <span class="s2">&quot;isreal1*isreal2*E_GB&quot;</span>
                <span class="p">)</span>
                <span class="n">force</span><span class="o">.</span><span class="n">setEnergyTermParameters</span><span class="p">(</span>
                    <span class="n">index</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">energy</span><span class="si">}</span><span class="s2">; E_GB=</span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">type</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">parameters</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parameter_list</span><span class="p">):</span>
                <span class="n">force</span><span class="o">.</span><span class="n">setParticleParameters</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">parameters</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">parameter_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">openmm</span><span class="o">.</span><span class="n">GBSAOBCForce</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;GBSAOBCForce not supported&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="ExtendedSpaceContext.getState">
<a class="viewcode-back" href="../../pythonapi/ufedmm.html#ufedmm.ufedmm.ExtendedSpaceContext.getState">[docs]</a>
    <span class="k">def</span> <span class="nf">getState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a :class:`ExtendedSpaceState` object.</span>

<span class="sd">        .. _getState: http://docs.openmm.org/latest/api-python/generated/openmm.openmm.Context.html#openmm.openmm.Context.getState  # noqa: E501</span>

<span class="sd">        Keyword Args</span>
<span class="sd">        ------------</span>
<span class="sd">            **kwargs</span>
<span class="sd">                See getState_.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ExtendedSpaceState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div>


<div class="viewcode-block" id="ExtendedSpaceContext.setPeriodicBoxVectors">
<a class="viewcode-back" href="../../pythonapi/ufedmm.html#ufedmm.ufedmm.ExtendedSpaceContext.setPeriodicBoxVectors">[docs]</a>
    <span class="k">def</span> <span class="nf">setPeriodicBoxVectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the vectors defining the axes of the periodic box.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            Only orthorhombic boxes are allowed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            a : openmm.Vec3</span>
<span class="sd">                The vector defining the first edge of the periodic box.</span>
<span class="sd">            b : openmm.Vec3</span>
<span class="sd">                The vector defining the second edge of the periodic box.</span>
<span class="sd">            c : openmm.Vec3</span>
<span class="sd">                The vector defining the third edge of the periodic box.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">openmm</span><span class="o">.</span><span class="n">Vec3</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="n">_standardized</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">openmm</span><span class="o">.</span><span class="n">Vec3</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="n">_standardized</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">openmm</span><span class="o">.</span><span class="n">Vec3</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="n">_standardized</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">y</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">z</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">z</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="n">y</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only orthorhombic boxes are allowed&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setParameter</span><span class="p">(</span><span class="s2">&quot;Lx&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setPeriodicBoxVectors</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSystem</span><span class="p">()</span>
        <span class="n">ntotal</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()</span>
        <span class="n">nvars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">):</span>
            <span class="n">system</span><span class="o">.</span><span class="n">setParticleMass</span><span class="p">(</span><span class="n">ntotal</span> <span class="o">-</span> <span class="n">nvars</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">_particle_mass</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reinitialize</span><span class="p">(</span><span class="n">preserveState</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="ExtendedSpaceContext.setPositions">
<a class="viewcode-back" href="../../pythonapi/ufedmm.html#ufedmm.ufedmm.ExtendedSpaceContext.setPositions">[docs]</a>
    <span class="k">def</span> <span class="nf">setPositions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">extended_positions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the positions of all particles and extended-space variables in this</span>
<span class="sd">        context. If the latter are not provided, then suitable values are automatically</span>
<span class="sd">        determined from the particle positions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            positions : list of openmm.Vec3</span>
<span class="sd">                The positions of physical particles.</span>

<span class="sd">        Keyword Args</span>
<span class="sd">        ------------</span>
<span class="sd">            extended_positions : list of float or unit.Quantity</span>
<span class="sd">                The positions of extended-space particles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getState</span><span class="p">()</span><span class="o">.</span><span class="n">getPeriodicBoxVectors</span><span class="p">()</span>
        <span class="n">nvars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
        <span class="n">particle_positions</span> <span class="o">=</span> <span class="n">_standardized</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extended_positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extra_positions</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">openmm</span><span class="o">.</span><span class="n">Vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nvars</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvars</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">minisystem</span> <span class="o">=</span> <span class="n">openmm</span><span class="o">.</span><span class="n">System</span><span class="p">()</span>
            <span class="n">expression</span> <span class="o">=</span> <span class="n">_get_energy_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">):</span>
                <span class="n">expression</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;; </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">_get_energy_function</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">openmm</span><span class="o">.</span><span class="n">CustomCompoundBondForce</span><span class="p">(</span><span class="n">nvars</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nvars</span><span class="p">),</span> <span class="p">[])</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">_get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s2">&quot;Lx&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                <span class="n">minisystem</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">_particle_mass</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">colvars</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">getSystem</span><span class="p">(),</span> <span class="n">particle_positions</span> <span class="o">+</span> <span class="n">extra_positions</span>
                    <span class="p">)</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="n">cv</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">minisystem</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
            <span class="n">minicontext</span> <span class="o">=</span> <span class="n">openmm</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span>
                <span class="n">minisystem</span><span class="p">,</span>
                <span class="n">openmm</span><span class="o">.</span><span class="n">CustomIntegrator</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">openmm</span><span class="o">.</span><span class="n">Platform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="s2">&quot;Reference&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">minicontext</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">extra_positions</span><span class="p">)</span>
            <span class="n">openmm</span><span class="o">.</span><span class="n">LocalEnergyMinimizer</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
                <span class="n">minicontext</span><span class="p">,</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">kilojoules_per_mole</span> <span class="o">/</span> <span class="n">unit</span><span class="o">.</span><span class="n">nanometers</span><span class="p">,</span> <span class="mi">0</span>
            <span class="p">)</span>
            <span class="n">ministate</span> <span class="o">=</span> <span class="n">minicontext</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getPositions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">extra_positions</span> <span class="o">=</span> <span class="n">ministate</span><span class="o">.</span><span class="n">getPositions</span><span class="p">()</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">nanometers</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extra_positions</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">openmm</span><span class="o">.</span><span class="n">Vec3</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nvars</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">extended_positions</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">particle_positions</span> <span class="o">+</span> <span class="n">extra_positions</span><span class="p">)</span></div>


<div class="viewcode-block" id="ExtendedSpaceContext.setVelocitiesToTemperature">
<a class="viewcode-back" href="../../pythonapi/ufedmm.html#ufedmm.ufedmm.ExtendedSpaceContext.setVelocitiesToTemperature">[docs]</a>
    <span class="k">def</span> <span class="nf">setVelocitiesToTemperature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">randomSeed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the velocities of all particles in the system to random values chosen</span>
<span class="sd">        from a Maxwell-Boltzmann distribution at a given temperature.</span>

<span class="sd">        .. warning ::</span>
<span class="sd">            The velocities of the extended-space variables are set to values consistent</span>
<span class="sd">            with the distribution at its own specified temperature.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            temperature : float or unit.Quantity</span>
<span class="sd">                The temperature of the system.</span>

<span class="sd">        Keyword Args</span>
<span class="sd">        ------------</span>
<span class="sd">            randomSeed : int, default=None</span>
<span class="sd">                A seed for the random number generator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSystem</span><span class="p">()</span>
        <span class="n">Ntotal</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()</span>
        <span class="n">Natoms</span> <span class="o">=</span> <span class="n">Ntotal</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">system</span><span class="o">.</span><span class="n">getParticleMass</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">unit</span><span class="o">.</span><span class="n">dalton</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ntotal</span><span class="p">)])</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">_standardized</span><span class="p">(</span><span class="n">temperature</span><span class="p">)]</span> <span class="o">*</span> <span class="n">Natoms</span>
            <span class="o">+</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">temperature</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_standardized</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">MOLAR_GAS_CONSTANT_R</span><span class="p">)</span> <span class="o">*</span> <span class="n">T</span> <span class="o">/</span> <span class="n">m</span><span class="p">)</span>
        <span class="n">random_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">randomSeed</span><span class="p">)</span>
        <span class="n">velocities</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">random_state</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">Ntotal</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setVelocities</span><span class="p">(</span><span class="n">velocities</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ExtendedSpaceSimulation">
<a class="viewcode-back" href="../../pythonapi/ufedmm.html#ufedmm.ufedmm.ExtendedSpaceSimulation">[docs]</a>
<span class="k">class</span> <span class="nc">ExtendedSpaceSimulation</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">Simulation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A simulation involving extended phase-space variables.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        variables : list of DynamicalVariable</span>
<span class="sd">            The dynamical variables to be added to the system&#39;s phase space.</span>
<span class="sd">        topology : openmm.app.Topology</span>
<span class="sd">            A Topology describing the system to be simulated.</span>
<span class="sd">        system : openmm.System</span>
<span class="sd">            The OpenMM System_ object to be simulated.</span>
<span class="sd">        integrator : openmm.Integrator</span>
<span class="sd">            The OpenMM Integrator to use for simulating the system dynamics.</span>

<span class="sd">    Keyword Args</span>
<span class="sd">    ------------</span>
<span class="sd">        platform : openmm.Platform, default=None</span>
<span class="sd">            If not None, the OpenMM Platform_ to use.</span>
<span class="sd">        platformProperties : dict, default=None</span>
<span class="sd">            If not None, a set of platform-specific properties to pass to the Context&#39;s</span>
<span class="sd">            constructor.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">variables</span><span class="p">,</span>
        <span class="n">topology</span><span class="p">,</span>
        <span class="n">system</span><span class="p">,</span>
        <span class="n">integrator</span><span class="p">,</span>
        <span class="n">platform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">platformProperties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="n">variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_periodic_tasks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">force</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">getForces</span><span class="p">():</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">force</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">if</span> <span class="bp">cls</span> <span class="o">==</span> <span class="s2">&quot;CMMotionRemover&quot;</span> <span class="ow">or</span> <span class="bp">cls</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;Barostat&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;UFED: system cannot contain CMMotionRemover nor any Barostat&quot;</span>
                <span class="p">)</span>

        <span class="n">box_vectors</span> <span class="o">=</span> <span class="n">topology</span><span class="o">.</span><span class="n">getPeriodicBoxVectors</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">box_vectors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;UFED: system must be confined in a simulation box&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span> <span class="o">=</span> <span class="n">topology</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="n">integrator</span>
        <span class="k">if</span> <span class="n">openmm</span><span class="o">.</span><span class="n">__version__</span> <span class="o">&lt;</span> <span class="s2">&quot;7.7&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentStep</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reporters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_usesPBC</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">ExtendedSpaceContext</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">platformProperties</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">ExtendedSpaceContext</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">platform</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">ExtendedSpaceContext</span><span class="p">(</span>
                <span class="n">variables</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">platform</span><span class="p">,</span> <span class="n">platformProperties</span>
            <span class="p">)</span>

<div class="viewcode-block" id="ExtendedSpaceSimulation.add_periodic_task">
<a class="viewcode-back" href="../../pythonapi/ufedmm.html#ufedmm.ufedmm.ExtendedSpaceSimulation.add_periodic_task">[docs]</a>
    <span class="k">def</span> <span class="nf">add_periodic_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">force_group</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds a task to be executed periodically along this simulation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            task : PeriodicTask</span>
<span class="sd">                A :class:`~ufedmm.ufedmm.PeriodicTask` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">task</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_periodic_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span></div>


<div class="viewcode-block" id="ExtendedSpaceSimulation.step">
<a class="viewcode-back" href="../../pythonapi/ufedmm.html#ufedmm.ufedmm.ExtendedSpaceSimulation.step">[docs]</a>
    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Executed a given number of simulation steps.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            steps : int</span>
<span class="sd">                The number of steps to be executed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">,</span> <span class="n">ufedmm</span><span class="o">.</span><span class="n">AbstractMiddleRespaIntegrator</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">_num_rattles</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">getNumConstraints</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Integrator cannot handle constraints&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_periodic_tasks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_periodic_tasks</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reporters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_periodic_tasks</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simulate</span><span class="p">(</span><span class="n">endStep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">currentStep</span> <span class="o">+</span> <span class="n">steps</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reporters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporters</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_periodic_tasks</span><span class="p">)</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simulate</span><span class="p">(</span><span class="n">endStep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">currentStep</span> <span class="o">+</span> <span class="n">steps</span><span class="p">)</span></div>


<div class="viewcode-block" id="ExtendedSpaceSimulation.saveCheckpoint">
<a class="viewcode-back" href="../../pythonapi/ufedmm.html#ufedmm.ufedmm.ExtendedSpaceSimulation.saveCheckpoint">[docs]</a>
    <span class="k">def</span> <span class="nf">saveCheckpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">saveCheckpoint</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_periodic_tasks</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">saveCheckpoint</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">createCheckpoint</span><span class="p">())</span></div>


<div class="viewcode-block" id="ExtendedSpaceSimulation.loadCheckpoint">
<a class="viewcode-back" href="../../pythonapi/ufedmm.html#ufedmm.ufedmm.ExtendedSpaceSimulation.loadCheckpoint">[docs]</a>
    <span class="k">def</span> <span class="nf">loadCheckpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loadCheckpoint</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_periodic_tasks</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">loadCheckpoint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">loadCheckpoint</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span></div>
</div>



<div class="viewcode-block" id="UnifiedFreeEnergyDynamics">
<a class="viewcode-back" href="../../pythonapi/ufedmm.html#ufedmm.ufedmm.UnifiedFreeEnergyDynamics">[docs]</a>
<span class="k">class</span> <span class="nc">UnifiedFreeEnergyDynamics</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A Unified Free-Energy Dynamics (UFED) setup.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        variables : list of DynamicalVariable</span>
<span class="sd">            The variables.</span>
<span class="sd">        temperature : float or unit.Quantity</span>
<span class="sd">            The temperature.</span>

<span class="sd">    Keyword Args</span>
<span class="sd">    ------------</span>
<span class="sd">        height : float or unit.Quantity, default=None</span>
<span class="sd">            The height.</span>
<span class="sd">        frequency : int, default=None</span>
<span class="sd">            The frequency.</span>
<span class="sd">        bias_factor : float, default=None</span>
<span class="sd">            Scales the height of the hills added to the metadynamics bias potential. If</span>
<span class="sd">            it is `None`, then the hills will have a constant height over time. For a</span>
<span class="sd">            bias factor to be applicable, all bias variables must be at the same</span>
<span class="sd">            temperature T. The extended-space dynamical variables are sampled as if the</span>
<span class="sd">            effective temperature were T*bias_factor.</span>
<span class="sd">        grid_expansion : int, default=20</span>
<span class="sd">            The grid expansion.</span>
<span class="sd">        enforce_gridless : bool, default=False</span>
<span class="sd">            If this is `True`, gridless metadynamics is enforced even for 1D to 3D</span>
<span class="sd">            problems.</span>
<span class="sd">        buffer_size : int, default=100</span>
<span class="sd">            The buffer size.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">        &gt;&gt;&gt; import ufedmm</span>
<span class="sd">        &gt;&gt;&gt; from openmm import unit</span>
<span class="sd">        &gt;&gt;&gt; model = ufedmm.AlanineDipeptideModel(water=&#39;tip3p&#39;)</span>
<span class="sd">        &gt;&gt;&gt; mass = 50*unit.dalton*(unit.nanometer/unit.radians)**2</span>
<span class="sd">        &gt;&gt;&gt; Ks = 1000*unit.kilojoules_per_mole/unit.radians**2</span>
<span class="sd">        &gt;&gt;&gt; Ts = 1500*unit.kelvin</span>
<span class="sd">        &gt;&gt;&gt; limit = 180*unit.degrees</span>
<span class="sd">        &gt;&gt;&gt; s_phi = ufedmm.DynamicalVariable(</span>
<span class="sd">        ...     &#39;s_phi&#39;, -limit, limit, mass, Ts, model.phi, Ks</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; s_psi = ufedmm.DynamicalVariable(</span>
<span class="sd">        ...     &#39;s_psi&#39;, -limit, limit, mass, Ts, model.psi, Ks</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; ufedmm.UnifiedFreeEnergyDynamics([s_phi, s_psi], 300*unit.kelvin)</span>
<span class="sd">        &lt;variables=[s_phi, s_psi], temperature=300, height=None, frequency=None&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">variables</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">frequency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">bias_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">grid_expansion</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">enforce_gridless</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">buffer_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="n">variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">_standardized</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">_standardized</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_factor</span> <span class="o">=</span> <span class="n">bias_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_expansion</span> <span class="o">=</span> <span class="n">grid_expansion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enforce_gridless</span> <span class="o">=</span> <span class="n">enforce_gridless</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">buffer_size</span>

        <span class="n">dimensions</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadynamics</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">dimensions</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">height</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">frequency</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;temperature=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;height=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;frequency=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;variables=[</span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span><span class="si">}</span><span class="s1">], </span><span class="si">{</span><span class="n">properties</span><span class="si">}</span><span class="s1">&gt;&#39;</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">variables</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
            <span class="n">frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span>
            <span class="n">bias_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_factor</span><span class="p">,</span>
            <span class="n">grid_expansion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_expansion</span><span class="p">,</span>
            <span class="n">enforce_gridless</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enforce_gridless</span><span class="p">,</span>
            <span class="n">buffer_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

<div class="viewcode-block" id="UnifiedFreeEnergyDynamics.simulation">
<a class="viewcode-back" href="../../pythonapi/ufedmm.html#ufedmm.ufedmm.UnifiedFreeEnergyDynamics.simulation">[docs]</a>
    <span class="k">def</span> <span class="nf">simulation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">platformProperties</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a ExtendedSpaceSimulation object.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            If the temperature of any driving parameter is different from the</span>
<span class="sd">            particle-system temperature, then the passed integrator must be a</span>
<span class="sd">            CustomIntegrator_ object containing a per-dof variable `kT` whose content is</span>
<span class="sd">            the Boltzmann constant times the temperature associated to each degree of</span>
<span class="sd">            freedom. This is true for all integrators available in</span>
<span class="sd">            :mod:`ufedmm.integrators`, which are subclasses of</span>
<span class="sd">            :class:`ufedmm.integrators.CustomIntegrator`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            topology : openmm.app.Topology</span>
<span class="sd">                The topology.</span>
<span class="sd">            system : openmm.System</span>
<span class="sd">                The system.</span>
<span class="sd">            integrator :</span>
<span class="sd">                The integrator.</span>

<span class="sd">        Keyword Args</span>
<span class="sd">        ------------</span>
<span class="sd">            platform : openmm.Platform, default=None</span>
<span class="sd">                The platform.</span>
<span class="sd">            platformProperties : dict, default=None</span>
<span class="sd">                The platform properties.</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">            &gt;&gt;&gt; import ufedmm</span>
<span class="sd">            &gt;&gt;&gt; from openmm import unit</span>
<span class="sd">            &gt;&gt;&gt; model = ufedmm.AlanineDipeptideModel(water=&#39;tip3p&#39;)</span>
<span class="sd">            &gt;&gt;&gt; mass = 50*unit.dalton*(unit.nanometer/unit.radians)**2</span>
<span class="sd">            &gt;&gt;&gt; Ks = 1000*unit.kilojoules_per_mole/unit.radians**2</span>
<span class="sd">            &gt;&gt;&gt; Ts = 1500*unit.kelvin</span>
<span class="sd">            &gt;&gt;&gt; dt = 2*unit.femtoseconds</span>
<span class="sd">            &gt;&gt;&gt; gamma = 10/unit.picoseconds</span>
<span class="sd">            &gt;&gt;&gt; limit = 180*unit.degrees</span>
<span class="sd">            &gt;&gt;&gt; s_phi = ufedmm.DynamicalVariable(</span>
<span class="sd">            ...    &#39;s_phi&#39;, -limit, limit, mass, Ts, model.phi, Ks</span>
<span class="sd">            ... )</span>
<span class="sd">            &gt;&gt;&gt; s_psi = ufedmm.DynamicalVariable(</span>
<span class="sd">            ...    &#39;s_psi&#39;, -limit, limit, mass, Ts, model.psi, Ks</span>
<span class="sd">            ... )</span>
<span class="sd">            &gt;&gt;&gt; ufed = ufedmm.UnifiedFreeEnergyDynamics([s_phi, s_psi], 300*unit.kelvin)</span>
<span class="sd">            &gt;&gt;&gt; integrator = ufedmm.GeodesicLangevinIntegrator(</span>
<span class="sd">            ...    300*unit.kelvin, gamma, dt</span>
<span class="sd">            ... )</span>
<span class="sd">            &gt;&gt;&gt; simulation = ufed.simulation(model.topology, model.system, integrator)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">simulation</span> <span class="o">=</span> <span class="n">ExtendedSpaceSimulation</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span>
            <span class="n">topology</span><span class="p">,</span>
            <span class="n">system</span><span class="p">,</span>
            <span class="n">integrator</span><span class="p">,</span>
            <span class="n">platform</span><span class="p">,</span>
            <span class="n">platformProperties</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadynamics</span><span class="p">:</span>
            <span class="n">simulation</span><span class="o">.</span><span class="n">add_periodic_task</span><span class="p">(</span>
                <span class="n">_Metadynamics</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span>
                    <span class="n">bias_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_factor</span><span class="p">,</span>
                    <span class="n">buffer_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span><span class="p">,</span>
                    <span class="n">grid_expansion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_expansion</span><span class="p">,</span>
                    <span class="n">enforce_gridless</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enforce_gridless</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">temperature</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">):</span>
            <span class="n">ntotal</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()</span>
            <span class="n">nvars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
            <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span>
                <span class="p">[</span><span class="n">openmm</span><span class="o">.</span><span class="n">Vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ntotal</span> <span class="o">-</span> <span class="n">nvars</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">nvars</span>
            <span class="p">)</span>
            <span class="n">vartemps</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">temperature</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">integrator</span><span class="p">,</span> <span class="n">ufedmm</span><span class="o">.</span><span class="n">integrators</span><span class="o">.</span><span class="n">CustomIntegrator</span><span class="p">):</span>
                <span class="n">integrator</span><span class="o">.</span><span class="n">update_temperatures</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span> <span class="n">vartemps</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">temperatures</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ntotal</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">vartemps</span><span class="p">))</span> <span class="o">+</span> <span class="n">vartemps</span>
                <span class="n">kT</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">unit</span><span class="o">.</span><span class="n">MOLAR_GAS_CONSTANT_R</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="n">openmm</span><span class="o">.</span><span class="n">Vec3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="n">temperatures</span>
                <span class="p">]</span>
                <span class="n">integrator</span><span class="o">.</span><span class="n">setPerDofVariableByName</span><span class="p">(</span><span class="s2">&quot;kT&quot;</span><span class="p">,</span> <span class="n">kT</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">simulation</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">UFED for OpenMM</a></h1>











<h3><a href="../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html#contributing">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pythonapi/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html">Bibliography</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2020, Charlles Abreu. Project structure based on the Computational Molecular Science Python Cookiecutter version 1.0.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>
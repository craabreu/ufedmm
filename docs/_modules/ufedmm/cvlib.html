
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ufedmm.cvlib &#8212; UFED for OpenMM  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ufedmm.cvlib</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: cvlib</span>
<span class="sd">   :platform: Unix, Windows</span>
<span class="sd">   :synopsis: A collection of custom collective variables</span>

<span class="sd">.. moduleauthor:: Charlles Abreu &lt;abreu@eq.ufrj.br&gt;</span>

<span class="sd">.. _Context:</span>
<span class="sd">    http://docs.openmm.org/latest/api-python/generated/openmm.openmm.Context.html</span>
<span class="sd">.. _CustomCVForce:</span>
<span class="sd">    http://docs.openmm.org/latest/api-python/generated/openmm.openmm.CustomCVForce.html</span>
<span class="sd">.. _CustomIntegrator:</span>
<span class="sd">    http://docs.openmm.org/latest/api-python/generated/openmm.openmm.CustomIntegrator.html</span>
<span class="sd">.. _Force:</span>
<span class="sd">    http://docs.openmm.org/latest/api-python/generated/openmm.openmm.Force.html</span>
<span class="sd">.. _NonbondedForce:</span>
<span class="sd">    http://docs.openmm.org/latest/api-python/generated/openmm.openmm.NonbondedForce.html</span>
<span class="sd">.. _System:</span>
<span class="sd">    http://docs.openmm.org/latest/api-python/generated/openmm.openmm.System.html</span>
<span class="sd">.. _coordination:</span>
<span class="sd">    https://www.plumed.org/doc-v2.6/user-doc/html/_c_o_o_r_d_i_n_a_t_i_o_n.html</span>
<span class="sd">.. _PLUMED:</span>
<span class="sd">    https://www.plumed.org</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="kn">import</span> <span class="nn">openmm</span>
<span class="kn">from</span> <span class="nn">openmm</span> <span class="kn">import</span> <span class="n">unit</span>

<span class="kn">from</span> <span class="nn">ufedmm.ufedmm</span> <span class="kn">import</span> <span class="n">_standardized</span>

<span class="n">_ParamTuple</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;_ParamTuple&quot;</span><span class="p">,</span> <span class="s2">&quot;charge sigma epsilon&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="SquareRadiusOfGyration"><a class="viewcode-back" href="../../pythonapi/cvlib.html#ufedmm.cvlib.SquareRadiusOfGyration">[docs]</a><span class="k">class</span> <span class="nc">SquareRadiusOfGyration</span><span class="p">(</span><span class="n">openmm</span><span class="o">.</span><span class="n">CustomBondForce</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The square of the radius of gyration of a group of atoms, defined as:</span>

<span class="sd">    .. math::</span>
<span class="sd">        R_g^2 = \\frac{1}{n^2} \\sum_i \\sum_{j&gt;i} r_{i,j}^2,</span>

<span class="sd">    where :math:`n` is the number of atoms in the group and :math:`r_{i,j}` is the distance between</span>
<span class="sd">    atoms `i` and `j`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        group : list(int)</span>
<span class="sd">            The indices of the atoms in the group.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">        &gt;&gt;&gt; import openmm</span>
<span class="sd">        &gt;&gt;&gt; import ufedmm</span>
<span class="sd">        &gt;&gt;&gt; from ufedmm import cvlib</span>
<span class="sd">        &gt;&gt;&gt; model = ufedmm.AlanineDipeptideModel()</span>
<span class="sd">        &gt;&gt;&gt; RgSq = cvlib.SquareRadiusOfGyration(range(model.system.getNumParticles()))</span>
<span class="sd">        &gt;&gt;&gt; RgSq.setForceGroup(1)</span>
<span class="sd">        &gt;&gt;&gt; model.system.addForce(RgSq)</span>
<span class="sd">        4</span>
<span class="sd">        &gt;&gt;&gt; platform = openmm.Platform.getPlatformByName(&#39;Reference&#39;)</span>
<span class="sd">        &gt;&gt;&gt; context = openmm.Context(model.system, openmm.CustomIntegrator(0), platform)</span>
<span class="sd">        &gt;&gt;&gt; context.setPositions(model.positions)</span>
<span class="sd">        &gt;&gt;&gt; context.getState(getEnergy=True, groups={1}).getPotentialEnergy()._value</span>
<span class="sd">        0.08711416289256209</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;r^2/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setUsesPeriodicBoundaryConditions</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span></div>


<div class="viewcode-block" id="RadiusOfGyration"><a class="viewcode-back" href="../../pythonapi/cvlib.html#ufedmm.cvlib.RadiusOfGyration">[docs]</a><span class="k">class</span> <span class="nc">RadiusOfGyration</span><span class="p">(</span><span class="n">openmm</span><span class="o">.</span><span class="n">CustomCVForce</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The radius of gyration of a group of atoms, defined as:</span>

<span class="sd">    .. math::</span>
<span class="sd">        R_g = \\frac{1}{n} \\sqrt{\\sum_i \\sum_{j&gt;i} r_{i,j}^2},</span>

<span class="sd">    where :math:`n` is the number of atoms in the group and :math:`r_{i,j}` is the distance between</span>
<span class="sd">    atoms `i` and `j`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        group : list(int)</span>
<span class="sd">            The indices of the atoms in the group.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">        &gt;&gt;&gt; import openmm</span>
<span class="sd">        &gt;&gt;&gt; import ufedmm</span>
<span class="sd">        &gt;&gt;&gt; from ufedmm import cvlib</span>
<span class="sd">        &gt;&gt;&gt; model = ufedmm.AlanineDipeptideModel()</span>
<span class="sd">        &gt;&gt;&gt; Rg = cvlib.RadiusOfGyration(range(model.system.getNumParticles()))</span>
<span class="sd">        &gt;&gt;&gt; Rg.setForceGroup(1)</span>
<span class="sd">        &gt;&gt;&gt; model.system.addForce(Rg)</span>
<span class="sd">        4</span>
<span class="sd">        &gt;&gt;&gt; platform = openmm.Platform.getPlatformByName(&#39;Reference&#39;)</span>
<span class="sd">        &gt;&gt;&gt; context = openmm.Context(model.system, openmm.CustomIntegrator(0), platform)</span>
<span class="sd">        &gt;&gt;&gt; context.setPositions(model.positions)</span>
<span class="sd">        &gt;&gt;&gt; context.getState(getEnergy=True, groups={1}).getPotentialEnergy()._value</span>
<span class="sd">        0.2951510848575048</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="n">RgSq</span> <span class="o">=</span> <span class="n">openmm</span><span class="o">.</span><span class="n">CustomBondForce</span><span class="p">(</span><span class="s2">&quot;r^2&quot;</span><span class="p">)</span>
        <span class="n">RgSq</span><span class="o">.</span><span class="n">setUsesPeriodicBoundaryConditions</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">RgSq</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sqrt(RgSq)/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCollectiveVariable</span><span class="p">(</span><span class="s2">&quot;RgSq&quot;</span><span class="p">,</span> <span class="n">RgSq</span><span class="p">)</span></div>


<div class="viewcode-block" id="CoordinationNumber"><a class="viewcode-back" href="../../pythonapi/cvlib.html#ufedmm.cvlib.CoordinationNumber">[docs]</a><span class="k">class</span> <span class="nc">CoordinationNumber</span><span class="p">(</span><span class="n">openmm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     A continuos approximation for the number of neighbor pairs among atoms of two groups,</span>
<span class="sd">     defined as:</span>

<span class="sd">    .. math::</span>
<span class="sd">        N_{\\mathbf{g}_1, \\mathbf{g}_2}(\\mathbf{r}) =</span>
<span class="sd">                     \\sum_{i \\in \\mathbf{g}_1} \\sum_{j \\in \\mathbf{g}_2}</span>
<span class="sd">                     S\\left(\\frac{r_{i,j}}{r_0}-1\\right) F_n \\left(\\frac{r_{i,j}}{r_0}\\right)</span>

<span class="sd">    where :math:`r_0` is a threshold distance and :math:`r_{ij}` is the distance between atoms</span>
<span class="sd">    :math:`i \\in \\mathbf{g}_1` and :math:`j \\in \\mathbf{g}_2`.</span>
<span class="sd">    The function :math:`F_n(x)` is a continuous step function defined as</span>

<span class="sd">    .. math::</span>
<span class="sd">        F_n(x) = \\frac{1}{1+x^n}</span>

<span class="sd">    where :math:`n` is a sharpness parameter. With :math:`n = 6` (default), this is the same</span>
<span class="sd">    function defined in :cite:`Iannuzzi_2003`.</span>
<span class="sd">    It is also a special case with :math:`d_0 = 0` and :math:`m=2n` of the coordination_ collective</span>
<span class="sd">    variable defined in PLUMED_.</span>
<span class="sd">    It has the following shape for varying `n` values:</span>

<span class="sd">    .. image::</span>
<span class="sd">        figures/coordination_number.png</span>
<span class="sd">        :align: center</span>

<span class="sd">    Besides, :math:`S(x)` is a switching function given by</span>

<span class="sd">    .. math::</span>
<span class="sd">        S(x) = \\begin{cases}</span>
<span class="sd">                   1 &amp; x &lt; 0 \\\\</span>
<span class="sd">                   1-6x^5+15x^4-10x^3 &amp; 0 \\leq x \\leq 1 \\\\</span>
<span class="sd">                   0 &amp; x &gt; 1</span>
<span class="sd">               \\end{cases}</span>

<span class="sd">    Thus, the amount summed up for each atom pair decays smoothly to zero throughout the interval</span>
<span class="sd">    :math:`r_{i,j} \\in [r_0, 2 r_0]`, meaning that :math:`2 r_0` is an actual cutoff distance.</span>

<span class="sd">    .. warning::</span>
<span class="sd">        If the two specified atom groups share atoms, each pair `i,j` among these atoms will be</span>
<span class="sd">        counted only once.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        system : openmm.System</span>
<span class="sd">            The system for which this collective variable will be computed.</span>
<span class="sd">        group1 : list(int)</span>
<span class="sd">            The indices of the atoms in the first group.</span>
<span class="sd">        group2 : list(int)</span>
<span class="sd">            The indices of the atoms in the second group.</span>

<span class="sd">    Keyword Args</span>
<span class="sd">    ------------</span>
<span class="sd">        n : int or float, default=6</span>
<span class="sd">            Exponent that controls the sharpness of the sigmoidal function.</span>
<span class="sd">        r0 : unit.Quantity, default=4*unit.angstroms</span>
<span class="sd">            The threshold distance, which is also half the actual cutoff distance.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">        &gt;&gt;&gt; import openmm</span>
<span class="sd">        &gt;&gt;&gt; import ufedmm</span>
<span class="sd">        &gt;&gt;&gt; from openmm import app</span>
<span class="sd">        &gt;&gt;&gt; from ufedmm import cvlib</span>
<span class="sd">        &gt;&gt;&gt; model = ufedmm.AlanineDipeptideModel()</span>
<span class="sd">        &gt;&gt;&gt; carbons = [</span>
<span class="sd">        ...     atom.index</span>
<span class="sd">        ...     for atom in model.topology.atoms()</span>
<span class="sd">        ...     if atom.element == app.element.carbon</span>
<span class="sd">        ... ]</span>
<span class="sd">        &gt;&gt;&gt; oxygens = [</span>
<span class="sd">        ...     atom.index</span>
<span class="sd">        ...     for atom in model.topology.atoms()</span>
<span class="sd">        ...     if atom.element == app.element.carbon</span>
<span class="sd">        ... ]</span>
<span class="sd">        &gt;&gt;&gt; N = cvlib.CoordinationNumber(model.system, carbons, oxygens)</span>
<span class="sd">        &gt;&gt;&gt; N.setForceGroup(1)</span>
<span class="sd">        &gt;&gt;&gt; model.system.addForce(N)</span>
<span class="sd">        4</span>
<span class="sd">        &gt;&gt;&gt; platform = openmm.Platform.getPlatformByName(&#39;Reference&#39;)</span>
<span class="sd">        &gt;&gt;&gt; context = openmm.Context(model.system, openmm.CustomIntegrator(0), platform)</span>
<span class="sd">        &gt;&gt;&gt; context.setPositions(model.positions)</span>
<span class="sd">        &gt;&gt;&gt; context.getState(getEnergy=True, groups={1}).getPotentialEnergy()._value</span>
<span class="sd">        9.461968618078124</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">r0</span><span class="o">=</span><span class="mi">4</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">angstroms</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;1/(1+(r/r0)^</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">system</span><span class="o">.</span><span class="n">usesPeriodicBoundaryConditions</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">openmm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">openmm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addParticle</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s2">&quot;r0&quot;</span><span class="p">,</span> <span class="n">r0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setUseSwitchingFunction</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setSwitchingDistance</span><span class="p">(</span><span class="n">r0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">r0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setUseLongRangeCorrection</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addInteractionGroup</span><span class="p">(</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">)</span></div>


<div class="viewcode-block" id="HelixAngleContent"><a class="viewcode-back" href="../../pythonapi/cvlib.html#ufedmm.cvlib.HelixAngleContent">[docs]</a><span class="k">class</span> <span class="nc">HelixAngleContent</span><span class="p">(</span><span class="n">openmm</span><span class="o">.</span><span class="n">CustomAngleForce</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     Fractional alpha-helix content of a sequence of residues in a protein chain based on the</span>
<span class="sd">     angles between consecutive alpha-carbon atoms, defined as follows:</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\alpha_\\theta(r_M,\\cdots,r_N) = \\frac{1}{N-M-1} \\sum_{i=M+1}^{N-1} F_n\\left(</span>
<span class="sd">        \\frac{\\theta(\\mathrm{C}_\\alpha^{i-1},\\mathrm{C}_\\alpha^i,\\mathrm{C}_\\alpha^{i+1})</span>
<span class="sd">        - \\theta_\\mathrm{ref}}{\\theta_\\mathrm{tol}}\\right)</span>

<span class="sd">    where :math:`\\theta(\\mathrm{C}_\\alpha^{i-1},\\mathrm{C}_\\alpha^i,\\mathrm{C}_\\alpha^{i+1})`</span>
<span class="sd">    is the angle between three consecutive alpha-carbon atoms, :math:`\\theta_\\mathrm{ref}` is the</span>
<span class="sd">    reference value of this angle, and :math:`\\theta_\\mathrm{tol}` is the tolerance threshold</span>
<span class="sd">    around this reference.</span>

<span class="sd">    The function :math:`F_n(x)` is defined as in :class:`CoordinationNumber`, but only even integer</span>
<span class="sd">    values are accepted for `n`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        topology : openmm.app.Topology</span>
<span class="sd">            The topology of the system for which this collective variable will be computed.</span>
<span class="sd">        first, last : int</span>
<span class="sd">            The indices of the first and last residues involved in the alpha helix.</span>

<span class="sd">    Keyword Args</span>
<span class="sd">    ------------</span>
<span class="sd">        n : even integer, default=6</span>
<span class="sd">            Exponent that controls the sharpness of the sigmoidal function.</span>
<span class="sd">        theta_ref : unit.Quantity, default=88*unit.degrees</span>
<span class="sd">            The reference value of the alpha carbon angle in the alpha helix.</span>
<span class="sd">        theta_tol : unit.Quantity, default=*unit.degrees</span>
<span class="sd">            The tolerance for the deviation from the alpha carbon angle.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">topology</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">theta_ref</span><span class="o">=</span><span class="mi">88</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">degrees</span><span class="p">,</span> <span class="n">theta_tol</span><span class="o">=</span><span class="mi">15</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">degrees</span>
    <span class="p">):</span>
        <span class="n">residues</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">topology</span><span class="o">.</span><span class="n">residues</span><span class="p">()</span> <span class="k">if</span> <span class="n">first</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">residues</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;AngleHelixContent requires all residues in a single chain&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;AngleHelixContent requires n to be an even integer number&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;1/(</span><span class="si">{</span><span class="n">last</span><span class="o">-</span><span class="n">first</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">*(1+x^</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">)); x=(theta - theta_ref)/theta_tol&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s2">&quot;theta_ref&quot;</span><span class="p">,</span> <span class="n">theta_ref</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s2">&quot;theta_tol&quot;</span><span class="p">,</span> <span class="n">theta_tol</span><span class="p">)</span>
        <span class="n">alpha_carbons</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">residues</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">atoms</span><span class="p">()</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;CA&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">alpha_carbons</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">alpha_carbons</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha_carbons</span><span class="p">[</span><span class="mi">2</span><span class="p">:]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addAngle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">[])</span></div>


<div class="viewcode-block" id="HelixHydrogenBondContent"><a class="viewcode-back" href="../../pythonapi/cvlib.html#ufedmm.cvlib.HelixHydrogenBondContent">[docs]</a><span class="k">class</span> <span class="nc">HelixHydrogenBondContent</span><span class="p">(</span><span class="n">openmm</span><span class="o">.</span><span class="n">CustomBondForce</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     Fractional alpha-helix content of a sequence of residues in a protein chain based on the</span>
<span class="sd">     hydrogen bonds between oxygen atoms and H-N groups located four residues apart, defined as</span>
<span class="sd">     follows:</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\alpha_\\mathrm{hb}(r_M,\\cdots,r_N) = \\frac{1}{M-N-2} \\sum_{i=M+2}^{N-2} F_n\\left(</span>
<span class="sd">        \\frac{d(\\mathrm{O}^{i-2}, \\mathrm{H}^{i+2})}{d_0}\\right)</span>

<span class="sd">    where :math:`d(\\mathrm{O}^{i-2}, \\mathrm{H}^{i+2})` is the distance between the oxygen and</span>
<span class="sd">    hydrogen atoms and :math:`d_0` is the threshold distance for characterizing a hydrogen bond.</span>

<span class="sd">    The function :math:`F_n(x)` is defined as in :class:`CoordinationNumber`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        topology : openmm.app.Topology</span>
<span class="sd">            The topology of the system for which this collective variable will be computed.</span>
<span class="sd">        first, last : int</span>
<span class="sd">            The indices of the first and last residues involved in the alpha helix.</span>

<span class="sd">    Keyword Args</span>
<span class="sd">    ------------</span>
<span class="sd">        n : int or float, default=6</span>
<span class="sd">            Exponent that controls the sharpness of the sigmoidal function.</span>
<span class="sd">        d0 : unit.Quantity, default=4*unit.angstroms</span>
<span class="sd">            The threshold distance, which is also half the actual cutoff distance.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topology</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">d0</span><span class="o">=</span><span class="mf">3.3</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">angstroms</span><span class="p">):</span>
        <span class="n">residues</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">topology</span><span class="o">.</span><span class="n">residues</span><span class="p">()</span> <span class="k">if</span> <span class="n">first</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">residues</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;HelixHydrogenBondContent requires all residues in a single chain&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;1/(</span><span class="si">{</span><span class="n">last</span><span class="o">-</span><span class="n">first</span><span class="o">-</span><span class="mi">2</span><span class="si">}</span><span class="s2">*(1+x^</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">)); x=r/d0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s2">&quot;d0&quot;</span><span class="p">,</span> <span class="n">d0</span><span class="p">)</span>
        <span class="n">reH</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b(H|1H|HN1|HT1|H1|HN)</span><span class="se">\\</span><span class="s2">b&quot;</span><span class="p">)</span>
        <span class="n">reO</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b(O|OCT1|OC1|OT1|O1)</span><span class="se">\\</span><span class="s2">b&quot;</span><span class="p">)</span>
        <span class="n">oxygens</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">residues</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">atoms</span><span class="p">()</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">reO</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>
        <span class="n">hydrogens</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">residues</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">atoms</span><span class="p">()</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">reH</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">oxygens</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">hydrogens</span><span class="p">[</span><span class="mi">3</span><span class="p">:]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">[])</span></div>


<div class="viewcode-block" id="HelixRamachandranContent"><a class="viewcode-back" href="../../pythonapi/cvlib.html#ufedmm.cvlib.HelixRamachandranContent">[docs]</a><span class="k">class</span> <span class="nc">HelixRamachandranContent</span><span class="p">(</span><span class="n">openmm</span><span class="o">.</span><span class="n">CustomTorsionForce</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     Fractional alpha-helix content of a sequence of residues in a protein chain based on the</span>
<span class="sd">     Ramachandran dihedral angles, defined as follows:</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\alpha_{\\phi,\\psi}(r_M,\\cdots,r_N) = \\frac{1}{2(N-M-1)} \\sum_{i=M+1}^{N-1} \\Bigg[</span>
<span class="sd">            F_n\\left(</span>
<span class="sd">                \\frac{\\phi(\\mathrm{C}^{i-1},\\mathrm{N}^i,\\mathrm{C}_\\alpha^i, \\mathrm{C}^i)</span>
<span class="sd">                - \\phi_\\mathrm{ref}}{\\phi_\\mathrm{tol}}</span>
<span class="sd">            \\right) + \\\\</span>
<span class="sd">            F_n\\left(</span>
<span class="sd">                \\frac{\\psi(\\mathrm{N}^i,\\mathrm{C}_\\alpha^i, \\mathrm{C}^i, \\mathrm{N}^{i+1})</span>
<span class="sd">                - \\psi_\\mathrm{ref}}{\\psi_\\mathrm{tol}}</span>
<span class="sd">            \\right)</span>
<span class="sd">        \\Bigg]</span>

<span class="sd">    where :math:`\\phi(\\mathrm{C}^{i-1},\\mathrm{N}^i,\\mathrm{C}_\\alpha^i, \\mathrm{C}^i)` and</span>
<span class="sd">    :math:`\\psi(\\mathrm{N}^i,\\mathrm{C}_\\alpha^i, \\mathrm{C}^i, \\mathrm{N}^{i+1})` are the</span>
<span class="sd">    Ramachandran dihedral angles, :math:`\\phi_\\mathrm{ref}` and :math:`\\psi_\\mathrm{ref}` are</span>
<span class="sd">    their reference values in an alpha helix, and :math:`\\phi_\\mathrm{tol}` and</span>
<span class="sd">    :math:`\\psi_\\mathrm{tol}` are the threshold tolerances around these refenrences.</span>

<span class="sd">    The function :math:`F_n(x)` is defined as in :class:`CoordinationNumber`, but only even integer</span>
<span class="sd">    values are accepted for `n`.</span>

<span class="sd">    Default values are the overall average alpha-helix dihedral angles and their dispersions</span>
<span class="sd">    reported in :cite:`Hovmoller_2002`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        topology : openmm.app.Topology</span>
<span class="sd">            The topology of the system for which this collective variable will be computed.</span>
<span class="sd">        first, last : int</span>
<span class="sd">            The indices of the first and last residues involved in the alpha helix.</span>

<span class="sd">    Keyword Args</span>
<span class="sd">    ------------</span>
<span class="sd">        n : even integer, default=6</span>
<span class="sd">            Exponent that controls the sharpness of the sigmoidal function.</span>
<span class="sd">        phi_ref : unit.Quantity, default=-63.8*unit.degrees</span>
<span class="sd">            The reference value of the Ramachandran :math:`\\phi` dihedral angle in the alpha helix.</span>
<span class="sd">        phi_tol : unit.Quantity, default=25*unit.degrees</span>
<span class="sd">            The tolerance for the deviation from the Ramachandran :math:`\\phi` dihedral angle.</span>
<span class="sd">        psi_ref : unit.Quantity, default=-41.1*unit.degrees</span>
<span class="sd">            The reference value of the Ramachandran :math:`\\psi` dihedral angle in the alpha helix.</span>
<span class="sd">        psi_tol : unit.Quantity, default=25*unit.degrees</span>
<span class="sd">            The tolerance for the deviation from the Ramachandran :math:`\\psi` dihedral angle.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">topology</span><span class="p">,</span>
        <span class="n">first</span><span class="p">,</span>
        <span class="n">last</span><span class="p">,</span>
        <span class="n">n</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
        <span class="n">phi_ref</span><span class="o">=-</span><span class="mf">63.8</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">degrees</span><span class="p">,</span>
        <span class="n">phi_tol</span><span class="o">=</span><span class="mi">25</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">degrees</span><span class="p">,</span>
        <span class="n">psi_ref</span><span class="o">=-</span><span class="mf">41.1</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">degrees</span><span class="p">,</span>
        <span class="n">psi_tol</span><span class="o">=</span><span class="mi">25</span> <span class="o">*</span> <span class="n">unit</span><span class="o">.</span><span class="n">degrees</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">residues</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">topology</span><span class="o">.</span><span class="n">residues</span><span class="p">()</span> <span class="k">if</span> <span class="n">first</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">residues</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;HelixRamachandranContent requires all residues in a single chain&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;1/(</span><span class="si">{</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">last</span><span class="o">-</span><span class="n">first</span><span class="p">)</span><span class="si">}</span><span class="s2">*(1+x^</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">)); x=(theta - theta_ref)/theta_tol&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPerTorsionParameter</span><span class="p">(</span><span class="s2">&quot;theta_ref&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPerTorsionParameter</span><span class="p">(</span><span class="s2">&quot;theta_tol&quot;</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">residues</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">atoms</span><span class="p">()</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;C&quot;</span><span class="p">]</span>
        <span class="n">N</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">residues</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">atoms</span><span class="p">()</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;N&quot;</span><span class="p">]</span>
        <span class="n">CA</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">residues</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">atoms</span><span class="p">()</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;CA&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">C</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">CA</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addTorsion</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="p">[</span><span class="n">phi_ref</span><span class="p">,</span> <span class="n">phi_tol</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">N</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">CA</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">C</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addTorsion</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="p">[</span><span class="n">psi_ref</span><span class="p">,</span> <span class="n">psi_tol</span><span class="p">])</span>

<div class="viewcode-block" id="HelixRamachandranContent.atom_indices"><a class="viewcode-back" href="../../pythonapi/cvlib.html#ufedmm.cvlib.HelixRamachandranContent.atom_indices">[docs]</a>    <span class="k">def</span> <span class="nf">atom_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            phi_indices : list of tuples</span>
<span class="sd">                The indices of the atoms in the :math:`\\phi` dihedrals.</span>
<span class="sd">            psi_indices : list of tuples</span>
<span class="sd">                The indices of the atoms in the :math:`\\psi` dihedrals.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNumTorsions</span><span class="p">()</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">phi_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">psi_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTorsionParameters</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">phi_indices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTorsionParameters</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="n">N</span><span class="p">)</span>
            <span class="n">psi_indices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">phi_indices</span><span class="p">,</span> <span class="n">psi_indices</span></div></div>


<span class="k">class</span> <span class="nc">_InOutForce</span><span class="p">(</span><span class="n">openmm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An abstract class for In/Out-force collective variables.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_import_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbforce</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nbforce</span><span class="o">.</span><span class="n">getCutoffDistance</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setUseSwitchingFunction</span><span class="p">(</span><span class="n">nbforce</span><span class="o">.</span><span class="n">getUseSwitchingFunction</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setSwitchingDistance</span><span class="p">(</span><span class="n">nbforce</span><span class="o">.</span><span class="n">getSwitchingDistance</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbforce</span><span class="o">.</span><span class="n">getNumExceptions</span><span class="p">()):</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nbforce</span><span class="o">.</span><span class="n">getExceptionParameters</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addExclusion</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbforce</span><span class="p">):</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbforce</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()):</span>
            <span class="n">charge</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">epsilon</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="o">/</span> <span class="n">p</span><span class="o">.</span><span class="n">unit</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">nbforce</span><span class="o">.</span><span class="n">getParticleParameters</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
            <span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_ParamTuple</span><span class="p">(</span><span class="n">charge</span><span class="p">,</span> <span class="n">sigma</span> <span class="k">if</span> <span class="n">epsilon</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">parameters</span>

    <span class="k">def</span> <span class="nf">_update_nonbonded_force</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">nbforce</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">pbc_for_exceptions</span><span class="p">):</span>
        <span class="n">internal_exception_pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbforce</span><span class="o">.</span><span class="n">getNumExceptions</span><span class="p">()):</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">epsilon</span> <span class="o">=</span> <span class="n">nbforce</span><span class="o">.</span><span class="n">getExceptionParameters</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">i_in_group</span><span class="p">,</span> <span class="n">j_in_group</span> <span class="o">=</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">group</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">group</span>
            <span class="k">if</span> <span class="n">i_in_group</span> <span class="ow">and</span> <span class="n">j_in_group</span><span class="p">:</span>
                <span class="n">internal_exception_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">i_in_group</span> <span class="ow">or</span> <span class="n">j_in_group</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No exceptions are allowed for in-group/out-group interactions&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">internal_exception_pairs</span><span class="p">:</span>
                <span class="n">chargeprod</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span> <span class="o">*</span> <span class="n">parameters</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span>
                <span class="n">sigma</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sigma</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">sigma</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">epsilon</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">*</span> <span class="n">parameters</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span>
                <span class="n">nbforce</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">chargeprod</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pbc_for_exceptions</span><span class="p">:</span>
            <span class="n">nbforce</span><span class="o">.</span><span class="n">setExceptionsUsePeriodicBoundaryConditions</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>


<div class="viewcode-block" id="InOutLennardJonesForce"><a class="viewcode-back" href="../../pythonapi/cvlib.html#ufedmm.cvlib.InOutLennardJonesForce">[docs]</a><span class="k">class</span> <span class="nc">InOutLennardJonesForce</span><span class="p">(</span><span class="n">_InOutForce</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Lennard-Jones (LJ) interactions between the atoms of a specified group and all other atoms</span>
<span class="sd">    in the system, referred to as in/out LJ interactions. All LJ parameters are imported from a</span>
<span class="sd">    provided NonbondedForce_ object, which is then modified so that all in-group interactions are</span>
<span class="sd">    treated as exceptions and all atoms of the group are removed from regular LJ interactions.</span>

<span class="sd">    .. note::</span>
<span class="sd">        No exceptions which involve in/out atom pairs are allowed.</span>

<span class="sd">    Warnings</span>
<span class="sd">    --------</span>
<span class="sd">        side effect:</span>
<span class="sd">            The constructor of this class modifies the passed NonbondedForce_ object.</span>

<span class="sd">    The model equation is:</span>

<span class="sd">    .. math::</span>
<span class="sd">        V_\\mathrm{LJ}(\\mathbf{r}) = \\sum_{i \\in \\mathcal{G}} \\sum_{j \\notin \\mathcal{G}}</span>
<span class="sd">        \\epsilon_{ij} u_\\mathrm{LJ}\\left(\\frac{r_{ij}}{\\sigma_{ij}}\\right)</span>

<span class="sd">    where :math:`\\mathcal{G}` is the specified group and</span>

<span class="sd">    .. math::</span>
<span class="sd">        u_\\mathrm{LJ}(x) = 4(x^{-12} - x^{-6})</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        group : list of int</span>
<span class="sd">            The atoms in the specified group.</span>
<span class="sd">        nbforce : openmm.NonbondedForce</span>
<span class="sd">            The NonbondedForce_ object from which the atom parameters are imported.</span>

<span class="sd">    Keyword Args</span>
<span class="sd">    ------------</span>
<span class="sd">        pbc_for_exceptions : bool, default=False</span>
<span class="sd">            Whether to consider periodic boundary conditions for exceptions in the NonbondedForce_</span>
<span class="sd">            object. This might be necessary if the specified group contains several detached</span>
<span class="sd">            molecules or one long molecule.</span>
<span class="sd">        softcore : bool, default=False</span>
<span class="sd">            Whether to include a softcore version :cite:`Beutler_1994` of the Lennard-Jones</span>
<span class="sd">            potential. In this case, a global variable `lambda_vdw` is added to the constructed</span>
<span class="sd">            object.</span>
<span class="sd">        keep_charges : bool, default=True</span>
<span class="sd">            Whether to keep the charges of the solute atoms. Otherwise, the charges of all solute</span>
<span class="sd">            atoms will be set to zero.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">        ValueError:</span>
<span class="sd">            Raised if there are any exceptions in the NonbondedForce_ object involving</span>
<span class="sd">            cross-group (i.e. in/out) atom pairs.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">nbforce</span><span class="p">,</span> <span class="n">pbc_for_exceptions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">softcore</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">keep_charges</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">u_LJ</span> <span class="o">=</span> <span class="s2">&quot;4/x^2-4/x&quot;</span>
        <span class="n">definitions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sigma=(sigma1+sigma2)/2&quot;</span><span class="p">,</span> <span class="s2">&quot;epsilon=sqrt(epsilon1*epsilon2)&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">softcore</span><span class="p">:</span>
            <span class="n">equations</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;lambda_vdw*epsilon*(</span><span class="si">{</span><span class="n">u_LJ</span><span class="si">}</span><span class="s2">); x=(r/sigma)^6+(1-lambda_vdw)/2&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">equations</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;epsilon*(</span><span class="si">{</span><span class="n">u_LJ</span><span class="si">}</span><span class="s2">); x=(r/sigma)^6&quot;</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">equations</span> <span class="o">+</span> <span class="n">definitions</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">softcore</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s2">&quot;lambda_vdw&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_parameters</span><span class="p">(</span><span class="n">nbforce</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s2">&quot;epsilon&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addParticle</span><span class="p">([</span><span class="n">parameter</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span> <span class="n">parameter</span><span class="o">.</span><span class="n">epsilon</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_nonbonded_force</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">nbforce</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">pbc_for_exceptions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_import_properties</span><span class="p">(</span><span class="n">nbforce</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addInteractionGroup</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">group</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nbforce</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setUseLongRangeCorrection</span><span class="p">(</span><span class="n">nbforce</span><span class="o">.</span><span class="n">getUseDispersionCorrection</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span> <span class="k">if</span> <span class="n">keep_charges</span> <span class="k">else</span> <span class="mf">0.0</span>
            <span class="n">nbforce</span><span class="o">.</span><span class="n">setParticleParameters</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

<div class="viewcode-block" id="InOutLennardJonesForce.capped_version"><a class="viewcode-back" href="../../pythonapi/cvlib.html#ufedmm.cvlib.InOutLennardJonesForce.capped_version">[docs]</a>    <span class="k">def</span> <span class="nf">capped_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a capped (Buelens-Grubmüller-type) version of the in/out Lennard-Jones force.</span>

<span class="sd">        The model equation is</span>

<span class="sd">        .. math::</span>
<span class="sd">            V_\\mathrm{BG}(\\mathbf{r}) = \\sum_{i \\in \\mathcal{G}} \\sum_{j \\notin \\mathcal{G}}</span>
<span class="sd">                \\epsilon_{ij} u_\\mathrm{BG}\\left(\\frac{r_{ij}}{\\sigma_{ij}}\\right)</span>

<span class="sd">        where</span>

<span class="sd">        .. math::</span>
<span class="sd">            u_\\mathrm{BG}(x) = \\left\\{ \\begin{array}{ccc}</span>
<span class="sd">                u_\\mathrm{cap}(x) &amp; \\mathrm{if} &amp; x &lt; 1 \\\\</span>
<span class="sd">                4(x^{-12} - x^{-6}) &amp; \\mathrm{if} &amp; x \\geq 1</span>
<span class="sd">            \\end{array}\\right.</span>

<span class="sd">        with</span>

<span class="sd">        .. math::</span>
<span class="sd">            u_\\mathrm{cap}(x) = \\left\\{ \\begin{array}{ccc}</span>
<span class="sd">                126 x^4 - 176 x^3 + 50 &amp;</span>
<span class="sd">                    \\mathrm{if} &amp; m = 2 \\\\</span>
<span class="sd">                \\frac{-4340 x^6 + 10944 x^5 - 7200 x^4 + 596}{5} &amp;</span>
<span class="sd">                    \\mathrm{if} &amp; m = 3 \\\\</span>
<span class="sd">                \\frac{43365 x^8 - 155880 x^7 + 191065 x^6 - 80472 x^5 + 1922}{35} &amp;</span>
<span class="sd">                    \\mathrm{if} &amp; m = 4</span>
<span class="sd">            \\end{array}\\right.</span>

<span class="sd">        Keyword Args</span>
<span class="sd">        ------------</span>
<span class="sd">            m : int, default=2</span>
<span class="sd">                The highest order of derivatives to be zero at :math:`r=0` and to match the</span>
<span class="sd">                Lennard-Jones values at :math:`r=\\sigma`. Valid options are 2, 3, and 4.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">u_LJ</span> <span class="o">=</span> <span class="s2">&quot;4/x^12-4/x^6&quot;</span>
        <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">u_cap</span> <span class="o">=</span> <span class="s2">&quot;126*x^4-176*x^3+50&quot;</span>
        <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">u_cap</span> <span class="o">=</span> <span class="s2">&quot;(-4340*x^6+10944*x^5-7200*x^4+596)/5&quot;</span>
        <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">u_cap</span> <span class="o">=</span> <span class="s2">&quot;(43365*x^8-155880*x^7+191065*x^6-80472*x^5+1922)/35&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Raised if an invalid `m` keyword value is passed.&quot;</span><span class="p">)</span>
        <span class="n">definitions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x=r/sigma&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma=(sigma1+sigma2)/2&quot;</span><span class="p">,</span> <span class="s2">&quot;epsilon=sqrt(epsilon1*epsilon2)&quot;</span><span class="p">]</span>
        <span class="n">equations</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;epsilon*select(step(1-x),</span><span class="si">{</span><span class="n">u_cap</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">u_LJ</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">definitions</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">openmm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">equations</span><span class="p">))</span>
        <span class="n">force</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s2">&quot;epsilon&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()):</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getParticleParameters</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getNumExclusions</span><span class="p">()):</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addExclusion</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">getExclusionParticles</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">force</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getCutoffDistance</span><span class="p">())</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setUseSwitchingFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getUseSwitchingFunction</span><span class="p">())</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setSwitchingDistance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSwitchingDistance</span><span class="p">())</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setUseLongRangeCorrection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getUseLongRangeCorrection</span><span class="p">())</span>
        <span class="n">force</span><span class="o">.</span><span class="n">addInteractionGroup</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">getInteractionGroupParameters</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">force</span></div></div>


<div class="viewcode-block" id="InOutCoulombForce"><a class="viewcode-back" href="../../pythonapi/cvlib.html#ufedmm.cvlib.InOutCoulombForce">[docs]</a><span class="k">class</span> <span class="nc">InOutCoulombForce</span><span class="p">(</span><span class="n">_InOutForce</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cut-off, pairwise Coulomb interactions between the atoms of a specified group and al other atoms</span>
<span class="sd">    in the system, referred to as in/out Coulomb interactions. All charges are imported from a</span>
<span class="sd">    provided NonbondedForce_ object, which is then modified so that all in-group interactions are</span>
<span class="sd">    treated as exceptions and all charges of the group atoms are scaled by a newly created Context_</span>
<span class="sd">    global parameter whose default value is 0.0.</span>

<span class="sd">    .. note::</span>
<span class="sd">        No exceptions which involve in/out atom pairs are allowed.</span>

<span class="sd">    Warnings</span>
<span class="sd">    --------</span>
<span class="sd">        side effect:</span>
<span class="sd">            The constructor of this class modifies the passed NonbondedForce_ object.</span>

<span class="sd">    The model equation is</span>

<span class="sd">    .. math::</span>
<span class="sd">        V_\\mathrm{coul}(\\mathbf{r}) = \\sum_{i \\in \\mathcal{G}} \\sum_{j \\notin \\mathcal{G}}</span>
<span class="sd">            \\frac{q_i q_j}{4 \\pi \\epsilon_0 r_c} u\\left(\\frac{r}{r_c}\\right)</span>

<span class="sd">    where :math:`\\mathcal{G}` is the specified group and the function :math:`u(x)` can be</span>
<span class="sd">    chosen from a number of different styles:</span>

<span class="sd">    1. Shifted:</span>

<span class="sd">    .. math::</span>
<span class="sd">        u(x) = \\frac{1}{x} - 1</span>

<span class="sd">    2. Shifted-force:</span>

<span class="sd">    .. math::</span>
<span class="sd">        u(x) = \\frac{1}{x} + x - 2</span>

<span class="sd">    3. Conductor Reaction-field (default):</span>

<span class="sd">        .. math::</span>
<span class="sd">            u(x) = \\frac{1}{x} + \\frac{x^2}{2} - \\frac{3}{2}</span>

<span class="sd">    4. Reaction-field (with finite dielectric constant :math:`\\epsilon`):</span>

<span class="sd">        .. math::</span>
<span class="sd">            u(x) = \\frac{1}{x} + \\frac{(2\\epsilon-1)x^2-3\\epsilon}{2\\epsilon+1}</span>

<span class="sd">    5. Damped:</span>

<span class="sd">    .. math::</span>
<span class="sd">        u(x) = \\frac{\\mathrm{erfc}(\\alpha_c x)}{x}</span>

<span class="sd">    6. Damped-shifted-force (DSF), with :math:`\\alpha_c = \\alpha r_c`:</span>

<span class="sd">    .. math::</span>
<span class="sd">        u(x) = \\frac{\\mathrm{erfc}(\\alpha_c x)}{x} - \\mathrm{erfc}(\\alpha_c) +</span>
<span class="sd">        \\left[\\mathrm{erfc}(\\alpha_c) +</span>
<span class="sd">        \\frac{2\\alpha_c e^{-\\alpha_c^2}}{\\sqrt{\\pi}}\\right]\\left(x - 1\\right)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        group : list of int</span>
<span class="sd">            The atoms in the specified group.</span>
<span class="sd">        nbforce : openmm.NonbondedForce</span>
<span class="sd">            The NonbondedForce_ object from which the atom charges are imported.</span>

<span class="sd">    Keyword Args</span>
<span class="sd">    ------------</span>
<span class="sd">        style : str, default=&#39;conductor-reaction-field&#39;</span>
<span class="sd">            The style of cutoff electrostatic potential to be used. Valid options are `shifted`,</span>
<span class="sd">            `shifted-force`, `reaction-field`, `conductor-reaction-field`, `damped`, and</span>
<span class="sd">            `damped-shifted-force`.</span>
<span class="sd">        damping_coefficient : float or unit.Quantity, default=0.2/unit.angstroms</span>
<span class="sd">            The damping coefficient :math:`\\alpha` in inverse distance unit.</span>
<span class="sd">        scaling_parameter_name : str, default=&#39;inOutCoulombScaling&#39;</span>
<span class="sd">            A Context_ global parameter whose value will multiply, in the passed NonbondedForce_</span>
<span class="sd">            object, the epsilon parameters of all atoms in the specified group.</span>
<span class="sd">        pbc_for_exceptions : bool, default=False</span>
<span class="sd">            Whether to consider periodic boundary conditions for exceptions in the NonbondedForce_</span>
<span class="sd">            object. This might be necessary if the specified group contains several detached</span>
<span class="sd">            molecules or one long molecule.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">        ValueError:</span>
<span class="sd">            Raised if there are any exceptions in the NonbondedForce_ object involving</span>
<span class="sd">            cross-group (i.e. in/out) atom pairs.</span>
<span class="sd">        ValueError:</span>
<span class="sd">            Raised if an invalid `style` keyword value is passed.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">group</span><span class="p">,</span>
        <span class="n">nbforce</span><span class="p">,</span>
        <span class="n">style</span><span class="o">=</span><span class="s2">&quot;conductor-reaction-field&quot;</span><span class="p">,</span>
        <span class="n">damping_coefficient</span><span class="o">=</span><span class="mf">0.2</span> <span class="o">/</span> <span class="n">unit</span><span class="o">.</span><span class="n">angstroms</span><span class="p">,</span>
        <span class="n">scaling_parameter_name</span><span class="o">=</span><span class="s2">&quot;inOutCoulombScaling&quot;</span><span class="p">,</span>
        <span class="n">pbc_for_exceptions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">_standardized</span><span class="p">(</span><span class="n">nbforce</span><span class="o">.</span><span class="n">getCutoffDistance</span><span class="p">())</span>
        <span class="n">alpha_c</span> <span class="o">=</span> <span class="n">_standardized</span><span class="p">(</span><span class="n">damping_coefficient</span><span class="p">)</span> <span class="o">*</span> <span class="n">rc</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mf">138.935485</span><span class="o">/</span><span class="n">rc</span><span class="si">}</span><span class="s2">*charge1*charge2&quot;</span>
        <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;shifted&quot;</span><span class="p">:</span>
            <span class="n">u_C</span> <span class="o">=</span> <span class="s2">&quot;1/x - 1&quot;</span>
        <span class="k">elif</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;shifted-force&quot;</span><span class="p">:</span>
            <span class="n">u_C</span> <span class="o">=</span> <span class="s2">&quot;1/x + x - 2&quot;</span>
        <span class="k">elif</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;conductor-reaction-field&quot;</span><span class="p">:</span>
            <span class="n">u_C</span> <span class="o">=</span> <span class="s2">&quot;1/x + x^2/2 - 3/2&quot;</span>
        <span class="k">elif</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;reaction-field&quot;</span><span class="p">:</span>
            <span class="n">epsilon</span> <span class="o">=</span> <span class="n">nbforce</span><span class="o">.</span><span class="n">getReactionFieldDielectric</span><span class="p">()</span>
            <span class="n">krf</span> <span class="o">=</span> <span class="p">(</span><span class="n">epsilon</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">epsilon</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">crf</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">epsilon</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">epsilon</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">u_C</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;1/x + </span><span class="si">{</span><span class="n">krf</span><span class="si">}</span><span class="s2">*x^2 - </span><span class="si">{</span><span class="n">crf</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;damped&quot;</span><span class="p">:</span>
            <span class="n">u_C</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;erfc(</span><span class="si">{</span><span class="n">alpha_c</span><span class="si">}</span><span class="s2">*x)/x&quot;</span>
        <span class="k">elif</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;damped-shifted-force&quot;</span><span class="p">:</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">erfc</span><span class="p">(</span><span class="n">alpha_c</span><span class="p">)</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">A</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">alpha_c</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">alpha_c</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">u_C</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;erfc(</span><span class="si">{</span><span class="n">alpha_c</span><span class="si">}</span><span class="s2">*x)/x + </span><span class="si">{</span><span class="n">A</span><span class="o">+</span><span class="n">B</span><span class="si">}</span><span class="s2">*x - </span><span class="si">{</span><span class="mi">2</span><span class="o">*</span><span class="n">A</span><span class="o">+</span><span class="n">B</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid cutoff electrostatic style&quot;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">*(</span><span class="si">{</span><span class="n">u_C</span><span class="si">}</span><span class="s2">); x=r/</span><span class="si">{</span><span class="n">rc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_parameters</span><span class="p">(</span><span class="n">nbforce</span><span class="p">)</span>
        <span class="n">offset_index</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbforce</span><span class="o">.</span><span class="n">getNumParticleParameterOffsets</span><span class="p">()):</span>
            <span class="n">variable</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nbforce</span><span class="o">.</span><span class="n">getParticleParameterOffset</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">variable</span> <span class="o">==</span> <span class="n">scaling_parameter_name</span><span class="p">:</span>
                <span class="n">offset_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
                <span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ParamTuple</span><span class="p">(</span><span class="n">charge</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span> <span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s2">&quot;charge&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addParticle</span><span class="p">([</span><span class="n">parameter</span><span class="o">.</span><span class="n">charge</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_nonbonded_force</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">nbforce</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">pbc_for_exceptions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_import_properties</span><span class="p">(</span><span class="n">nbforce</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addInteractionGroup</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">group</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nbforce</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setUseLongRangeCorrection</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">global_vars</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">nbforce</span><span class="o">.</span><span class="n">getGlobalParameterName</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbforce</span><span class="o">.</span><span class="n">getNumGlobalParameters</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">scaling_parameter_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">global_vars</span><span class="p">:</span>
            <span class="n">nbforce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="n">scaling_parameter_name</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
            <span class="n">charge</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">epsilon</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">nbforce</span><span class="o">.</span><span class="n">setParticleParameters</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="p">[</span><span class="n">scaling_parameter_name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">offset_index</span><span class="p">:</span>
                <span class="n">nbforce</span><span class="o">.</span><span class="n">setParticleParameterOffset</span><span class="p">(</span><span class="n">offset_index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">*</span><span class="nb">input</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nbforce</span><span class="o">.</span><span class="n">addParticleParameterOffset</span><span class="p">(</span><span class="o">*</span><span class="nb">input</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">UFED for OpenMM</a></h1>











<h3><a href="../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pythonapi/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html">Bibliography</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Charlles Abreu. Project structure based on the Computational Molecular Science Python Cookiecutter version 1.0.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 6.1.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>